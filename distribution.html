<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>近期攪珠號碼分布｜Mark6</title>
  <style>
    body { font-family: system-ui, -apple-system, "PingFang HK", "Noto Sans TC", Arial, sans-serif; margin: 24px; line-height: 1.55; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; }
    .muted { color:#666; font-size:14px; }
    button { padding:8px 10px; cursor:pointer; }
    button.on { background:#111; color:#fff; border:1px solid #111; }
    .legend { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .swatch { display:inline-block; width:14px; height:14px; border-radius:4px; border:1px solid #ddd; vertical-align:middle; margin-right:6px; }
    .swatch.main { background:#ffe26a; border-color:#f2d24b; }
    .swatch.extra { background:#ff4d4d; border-color:#e53f3f; }

    .tableWrap{
      overflow-x:auto;      /* 只允許水平捲動 */
      overflow-y:visible;   /* 垂直不捲 */
      border:1px solid #eee;
      border-radius:10px;
      max-height:none;      /* 取消高度限制 */
    }


    table { border-collapse:separate; border-spacing:0; width:max-content; min-width:100%; }
    th, td {
      border-bottom:1px solid #eee;
      border-right:1px solid #eee;
      padding:3px 4px;      /* ✅ 縮細 padding */
      font-size:12px;       /* ✅ 縮細字 */
      line-height:1.1;      /* ✅ 行高更緊 */
      text-align:center;
      white-space:nowrap;
      background:#fff;
      min-width:26px;       /* ✅ 每格最小寬度（你可以再細） */
    }

    th { background:#fafafa; font-weight:600; }
    tr:last-child td { border-bottom:none; }
    th:last-child, td:last-child { border-right:none; }

    /* sticky header */
    thead th { position: sticky; top: 0; z-index: 2; }

    /* sticky first column (numbers 1-49) */
    .stickyCol { position: sticky; left: 0; z-index: 3; background:#fafafa; }
    tbody .stickyCol { background:#fff; z-index: 1; font-weight:600; }

    /* cells *//* 正選命中：由波色決定 */
    .hitMain { font-weight:800; color:#fff; }   /* 字白色，易睇 */
    .c-red   { background:#d32f2f; }
    .c-blue  { background:#1976d2; }
    .c-green { background:#2e7d32; }
    
    /* 特別號：黃色 */
    .hitExtra { background:#f9d423; color:#111; font-weight:900; }


    .small { font-size:11px; color:#666; font-weight:500; display:block; margin-top:1px; }
    .err { color:#b00020; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
    .hitMain, .hitExtra { padding:2px 3px; }
    .hitMain { font-weight: 700; }
    .hitExtra { font-weight: 800; }

    .summaryRow td { background:#fafafa; font-weight:600; }
    .summaryLabel { text-align:left; }
    .summaryCell { font-size:12px; }

  </style>
</head>
<body>
  <h1>近期攪珠號碼分布</h1>
  <p class="muted">
    左邊為 1–49 號碼，上方為近 X 期（預設 10 期）。正選以黃色標示，特別號以紅色標示。
  </p>

  <div class="card">
    <div class="row">
      <div class="legend">
        <span><span class="swatch main"></span>正選</span>
        <span><span class="swatch extra"></span>特別號</span>
      </div>

      <div style="margin-left:auto;" class="row">
        <span class="muted">顯示期數：</span>
        <button class="preset on" data-n="20">近20期</button>
        <button class="preset" data-n="30">近30期</button>
        <button class="preset" data-n="60">近60期</button>
        <button id="reload">重新載入</button>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      提示：如你見到空白表格或錯誤，通常係 API <code>/api/draws</code> 未加好或回傳格式唔啱。
    </div>
  </div>

  <div class="card">
    <div id="status" class="muted">載入中…</div>
    <div id="error" class="err" style="margin-top:8px;"></div>

    <div class="tableWrap" style="margin-top:12px;">
      <table id="tbl" aria-label="近期攪珠號碼分布表"></table>
    </div>
  </div>

  <p><a href="/">返回首頁</a></p>

<script>
  const statusEl = document.getElementById("status");
  const errorEl = document.getElementById("error");
  const tbl = document.getElementById("tbl");
  const presetBtns = Array.from(document.querySelectorAll(".preset"));
  const reloadBtn = document.getElementById("reload");

  let currentN = 10;

  function pad2(n){ return String(n).padStart(2, "0"); }
  function fmtN(n){ return String(n); } // 1-49 不補零

  const RED = new Set([1,2,7,8,12,13,18,19,23,24,29,30,34,35,40,45,46]);
  const BLUE = new Set([3,4,9,10,14,15,20,25,26,31,36,37,41,42,47,48]);
  const GREEN = new Set([5,6,11,16,17,21,22,27,28,32,33,38,39,43,44,49]);
  
  function ballColor(n){
    if (RED.has(n)) return "red";
    if (BLUE.has(n)) return "blue";
    return "green";
  }


  function fmtYMD(ymd){
    if(!ymd) return "";
    // accept YYYY-MM-DD
    const m = String(ymd).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(m) return `${m[2]}/${m[3]}`; // show MM/DD compact
    return ymd;
  }

  function setActivePreset(n){
    currentN = n;
    presetBtns.forEach(b => b.classList.toggle("on", Number(b.dataset.n) === n));
  }

  async function fetchDraws(limit){
    const res = await fetch(`/api/draws?limit=${limit}`, { headers: { "accept":"application/json" } });
    const ct = res.headers.get("content-type") || "";
  
    if(!ct.includes("application/json")){
      const text = await res.text();
      throw new Error(`API 回傳非 JSON（HTTP ${res.status}）。前 200 字：` + text.slice(0,200));
    }
  
    const data = await res.json();
    if(!res.ok || data.ok !== true){
      throw new Error(data.error || `API ok=false（HTTP ${res.status}）`);
    }
    return data.draws || [];
  }


  function buildMatrix(draws){
    // columns = draws (latest first), rows = 1..49
    // We build a quick lookup per draw: Set of main numbers and extra
    const cols = draws.map(d => ({
      drawNo: d.drawNo,
      drawDate: d.drawDate,
      nums: (d.numbers || []).map(Number),   // 6 個正選
      main: new Set(d.numbers || []),
      extra: Number(d.extra)                 // 特別號
    }));

    // header
    let html = "<thead><tr>";
    html += `<th class="stickyCol">號碼</th>`;
    for(const c of cols){
      html += `<th>${c.drawNo}<span class="small">${fmtYMD(c.drawDate)}</span></th>`;
    }
    html += "</tr></thead>";

    // body
    html += "<tbody>";
    for(let n=1; n<=49; n++){
      html += "<tr>";
      html += `<td class="stickyCol">${fmtN(n)}</td>`;

    for(const c of cols){
      if (c.extra === n) {
        // 特別號：黃色
        html += `<td class="hitExtra">${fmtN(n)}</td>`;
      } else if (c.main.has(n)) {
        // 正選：按波色上色
        const cc = ballColor(n);
        html += `<td class="hitMain c-${cc}">${fmtN(n)}</td>`;
      } else {
        html += `<td></td>`;
      }
    }

      html += "</tr>";
    }

    // --- summary rows: total & average (6 main + extra) ---
    html += `<tr class="summaryRow">`;
    html += `<td class="stickyCol summaryLabel">攪出號碼總數</td>`;
    for (const c of cols) {
      const total = c.nums.reduce((a,b)=>a+b,0) + c.extra;
      html += `<td class="summaryCell">${total}</td>`;
    }
    html += `</tr>`;
    
    html += `<tr class="summaryRow">`;
    html += `<td class="stickyCol summaryLabel">攪出號碼平均數</td>`;
    for (const c of cols) {
      const total = c.nums.reduce((a,b)=>a+b,0) + c.extra;
      const avg = total / 7;
      html += `<td class="summaryCell">${avg.toFixed(1)}</td>`;
    }
    html += `</tr>`;

    html += `<tr class="summaryRow">`;
    html += `<td class="stickyCol summaryLabel">平均數大/小</td>`;
    for (const c of cols) {
      const total = c.nums.reduce((a,b)=>a+b,0) + c.extra;
      const avg = total / 7;
      const tag = (avg >= 24.5) ? "大" : "小";
      html += `<td class="summaryCell">${tag}</td>`;
    }
    html += `</tr>`;

    html += "</tbody>";

    tbl.innerHTML = html;
  }

  async function load(){
    errorEl.textContent = "";
    statusEl.textContent = `載入近 ${currentN} 期…`;
    tbl.innerHTML = "";

    try{
      const draws = await fetchDraws(currentN);
      if(!draws.length){
        statusEl.textContent = "未有資料。";
        return;
      }
      statusEl.textContent = `已載入近 ${draws.length} 期（由新到舊）。`;
      buildMatrix(draws);
    }catch(e){
      statusEl.textContent = "";
      errorEl.textContent = "載入失敗：" + e.message;
    }
  }

  presetBtns.forEach(b=>{
    b.addEventListener("click", ()=>{
      setActivePreset(Number(b.dataset.n));
      load();
    });
  });

  reloadBtn.addEventListener("click", load);

  // init
  setActivePreset(10);
  load();
</script>
</body>
</html>
