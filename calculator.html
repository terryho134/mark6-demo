<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>注數及獎金計算機｜Mark6</title>
  <style>
    body { font-family: system-ui, -apple-system, "PingFang HK", "Noto Sans TC", Arial, sans-serif; margin: 24px; line-height: 1.55; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; }
    .muted { color:#666; font-size:14px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f3f3; font-size:13px; margin-right:6px; }
    select, input, button { padding:8px 10px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-top:1px solid #eee; padding:10px 8px; vertical-align:top; text-align:left; }
    th { background:#fafafa; font-weight:600; }
    .warn { color:#b00020; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
    hr { border:none; border-top:1px solid #eee; margin:14px 0; }
    .nowrap { white-space: nowrap; }
    .subcard { border:1px dashed #ddd; border-radius:10px; padding:12px; margin:10px 0; background:#fcfcfc; }
  </style>
</head>
<body>
  <h1>注數及獎金計算機</h1>
  <p class="muted">
    輸入下注方式與數量（複式/膽拖），列出「所有命中情境」下各獎項中獎份數，以及四至七獎固定獎金（按全注/半注比例）。
    頭/二/三獎派彩浮動，本頁只顯示份數提示。
  </p>

  <div class="card">
    <h3 style="margin-top:0;">1) 下注方式</h3>
    <div class="row">
      <label><input type="radio" name="type" value="single" checked> 單式</label>
      <label><input type="radio" name="type" value="multiple"> 複式</label>
      <label><input type="radio" name="type" value="banker"> 膽拖</label>

      <label style="margin-left:auto;">
        半注（$5）
        <input id="half" type="checkbox">
      </label>
    </div>

    <hr>

    <div id="panelSingle" class="row">
      <span class="muted">單式固定 1 注（6 個號碼）。</span>
    </div>

    <div id="panelMultiple" style="display:none;">
      <div class="row">
        <label>複式號碼數</label>
        <select id="mulN"></select>
        <span class="muted">（7–49）</span>
      </div>
      <div class="muted" id="mulHint" style="margin-top:6px;"></div>
    </div>

    <div id="panelBanker" style="display:none;">
      <div class="row">
        <label>膽數</label>
        <select id="bN"></select>

        <label>腳數</label>
        <select id="lN"></select>

        <span class="muted">（總數 7–49；最大值為「全餐」）</span>
      </div>
      <div class="muted" style="margin-top:6px;">
        提示：膽拖的「中膽情況」選擇已移到下方「所有命中情境」卡內。
      </div>
    </div>

    <hr>

    <div class="row">
      <span class="pill" id="betsPill">注數：—</span>
      <span class="pill" id="stakePill">投注額：—</span>
      <span id="warn" class="muted"></span>
      <button id="calc" style="margin-left:auto;">更新</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">2) 所有命中情境（只顯示有派彩）</h3>

    <!-- ✅ Banker layer-2 moved here -->
    <div id="bankerLayer2" class="subcard" style="display:none;">
      <div class="row">
        <span class="pill">膽拖：中膽情況</span>
        <label>命中膽（正選/特別號）</label>
        <select id="bankerHit"></select>
      </div>
      <div class="muted" id="bankerHitHint" style="margin-top:6px;"></div>
    </div>

    <div id="out"></div>

    <div class="muted" style="margin-top:10px;">
      固定獎金（以全注 $10 為基準）：四獎 $9,600｜五獎 $640｜六獎 $320｜七獎 $40（半注按比例減半）。
    </div>
  </div>

  <p><a href="/">返回首頁</a>　｜　<a href="/checker.html">到核對器</a></p>

<script>
  // ---------- helpers ----------
  function fmtMoney(n){
    return "HK$ " + Number(n).toLocaleString("en-US");
  }
  function choose(n,k){
    if(k<0||n<0||k>n) return 0;
    k=Math.min(k,n-k);
    let r=1;
    for(let i=1;i<=k;i++) r=(r*(n-(k-i)))/i;
    return Math.round(r);
  }

  const PRIZE = { div4:9600, div5:640, div6:320, div7:40 };

  function fixedTotal(units, stakeRatio){
    const t = (
      units.div4*PRIZE.div4 +
      units.div5*PRIZE.div5 +
      units.div6*PRIZE.div6 +
      units.div7*PRIZE.div7
    );
    return Math.round(t * stakeRatio);
  }

  function summarizeUnits(units){
    const map = [
      ["div1","頭獎"],["div2","二獎"],["div3","三獎"],
      ["div4","四獎"],["div5","五獎"],["div6","六獎"],["div7","七獎"]
    ];
    const parts=[];
    for(const [k,name] of map){
      const v = units[k]||0;
      if(v>0) parts.push(`${name}×${v.toLocaleString("en-US")}`);
    }
    return parts.join("，");
  }

  function hasAnyPrize(units){
    return (units.div1+units.div2+units.div3+units.div4+units.div5+units.div6+units.div7)>0;
  }

  // ---------- scenario calculators (counts-based) ----------
  // Shared combinatorial formula for (x main hits, y extra hit?, z others)
  function unitsFromXYZN(x,y,z){
    const div1 = choose(x, 6);
    const div2 = y * choose(x, 5);
    const div3 = choose(x, 5) * choose(z, 1);
    const div4 = y * choose(x, 4) * choose(z, 1);
    const div5 = choose(x, 4) * choose(z, 2);
    const div6 = y * choose(x, 3) * choose(z, 2);
    const div7 = choose(x, 3) * choose(z, 3);
    return { div1, div2, div3, div4, div5, div6, div7 };
  }

  function listSingleScenarios(stakeRatio){
    const rows=[];
    const n=6;
    for(let x=0;x<=6;x++){
      for(let y=0;y<=1;y++){
        if(x+y>6) continue;
        if(x===6 && y===1) continue;
        const z = n - x - y;
        const units = unitsFromXYZN(x,y,z);
        if(!hasAnyPrize(units)) continue;

        rows.push({
          label: `命中：中${x}個正選${y===1 ? " + 特別號" : ""}`,
          units,
          fixed: fixedTotal(units, stakeRatio),
          topNote: (units.div1+units.div2+units.div3)>0 ? "頭/二/三獎派彩屬浮動（以官方 Unit Prize 為準）" : ""
        });
      }
    }
    rows.sort((a,b)=>{
      const score = (r)=> (r.units.div1*1e9 + r.units.div2*1e7 + r.units.div3*1e5 + r.fixed);
      return score(b)-score(a);
    });
    return rows;
  }

  function listMultipleScenarios(n, stakeRatio){
    const rows=[];
    for(let x=0;x<=Math.min(6,n);x++){
      for(let y=0;y<=1;y++){
        if(x+y>n) continue;
        if(x===6 && y===1) continue;
        const z = n - x - y;
        const units = unitsFromXYZN(x,y,z);
        if(!hasAnyPrize(units)) continue;

        rows.push({
          label:`命中：中${x}個正選${y===1 ? " + 特別號" : ""}`,
          units,
          fixed: fixedTotal(units, stakeRatio),
          topNote: (units.div1+units.div2+units.div3)>0 ? "頭/二/三獎派彩屬浮動（以官方 Unit Prize 為準）" : ""
        });
      }
    }
    rows.sort((a,b)=>{
      const getM = (s)=> (s.match(/中(\d+)個正選/)||[])[1] ? Number((s.match(/中(\d+)個正選/)||[])[1]) : 0;
      const ma=getM(a.label), mb=getM(b.label);
      if(mb!==ma) return mb-ma;
      const ea=a.label.includes("特別號")?1:0;
      const eb=b.label.includes("特別號")?1:0;
      if(eb!==ea) return eb-ea;
      return (b.fixed||0)-(a.fixed||0);
    });
    return rows;
  }

  // Banker scenario rows: given b, L, chosen bw & be, enumerate lw & le.
  function calcBankerUnitsFromCounts(b, L, bw, be, lw, le){
    const t = 6 - b;
    const lo = L - lw - le;
    if(lo < 0) return null;

    const units = { div1:0, div2:0, div3:0, div4:0, div5:0, div6:0, div7:0 };

    for(let k=0; k<=Math.min(lw, t); k++){
      for(let u=0; u<=Math.min(le, t-k); u++){
        const r = t - k - u;
        if(r<0 || r>lo) continue;

        const m = bw + k;
        const e = (be===1) ? 1 : u;
        const ways = choose(lw, k) * choose(le, u) * choose(lo, r);

        if(m===6) units.div1 += ways;
        else if(m===5 && e===1) units.div2 += ways;
        else if(m===5 && e===0) units.div3 += ways;
        else if(m===4 && e===1) units.div4 += ways;
        else if(m===4 && e===0) units.div5 += ways;
        else if(m===3 && e===1) units.div6 += ways;
        else if(m===3 && e===0) units.div7 += ways;
      }
    }
    return { units };
  }

  function listBankerRows(b, L, bw, be, stakeRatio){
    const rows=[];
    const lwMax = Math.min(L, 6 - bw);
    const leOptions = (be===1) ? [0] : [0,1];

    for(let lw=0; lw<=lwMax; lw++){
      for(const le of leOptions){
        if(lw + le > L) continue;

        const out = calcBankerUnitsFromCounts(b, L, bw, be, lw, le);
        if(!out) continue;
        if(!hasAnyPrize(out.units)) continue;

        const m = bw + lw;
        const e = (be===1 || le===1);

        const label = [
          `等效命中：中${m}個正選${e ? " + 特別號" : ""}`,
          `膽：${describeBankerHit(bw, be)}`,
          `腳中${lw}${(be===0 && le===1) ? "（特別號在腳）" : ""}`,
        ].join("｜");

        rows.push({
          label,
          units: out.units,
          fixed: fixedTotal(out.units, stakeRatio),
          topNote: (out.units.div1+out.units.div2+out.units.div3)>0 ? "頭/二/三獎派彩屬浮動（以官方 Unit Prize 為準）" : ""
        });
      }
    }

    rows.sort((a,b)=>{
      const getM = (s)=> (s.match(/中(\d+)個正選/)||[])[1] ? Number((s.match(/中(\d+)個正選/)||[])[1]) : 0;
      const ma=getM(a.label), mb=getM(b.label);
      if(mb!==ma) return mb-ma;
      const ea=a.label.includes("特別號")?1:0;
      const eb=b.label.includes("特別號")?1:0;
      if(eb!==ea) return eb-ea;
      return (b.fixed||0)-(a.fixed||0);
    });

    return rows;
  }

  // ---------- UI ----------
  const typeEls = Array.from(document.querySelectorAll('input[name="type"]'));
  const halfEl = document.getElementById("half");
  const panelSingle = document.getElementById("panelSingle");
  const panelMultiple = document.getElementById("panelMultiple");
  const panelBanker = document.getElementById("panelBanker");

  const mulN = document.getElementById("mulN");
  const mulHint = document.getElementById("mulHint");

  const bN = document.getElementById("bN");
  const lN = document.getElementById("lN");

  // moved layer2
  const bankerLayer2 = document.getElementById("bankerLayer2");
  const bankerHitEl = document.getElementById("bankerHit");
  const bankerHitHintEl = document.getElementById("bankerHitHint");

  const betsPill = document.getElementById("betsPill");
  const stakePill = document.getElementById("stakePill");
  const warnEl = document.getElementById("warn");
  const outEl = document.getElementById("out");

  let type="single";

  function syncPanels(){
    panelSingle.style.display = (type==="single") ? "" : "none";
    panelMultiple.style.display = (type==="multiple") ? "" : "none";
    panelBanker.style.display = (type==="banker") ? "" : "none";
    bankerLayer2.style.display = (type==="banker") ? "" : "none";
  }

  function unitStake(){ return halfEl.checked ? 5 : 10; }
  function stakeRatio(){ return halfEl.checked ? 0.5 : 1; }

  // ✅ legs dropdown depends on banker count: L in [7-b, 49-b], max shows (全餐)
  function populateLegOptions(){
    const b = parseInt(bN.value, 10);
    const minL = Math.max(7 - b, 1);
    const maxL = 49 - b;

    const prev = parseInt(lN.value || "0", 10);
    lN.innerHTML = "";

    for(let L=minL; L<=maxL; L++){
      const opt = document.createElement("option");
      opt.value = String(L);
      opt.textContent = (L === maxL) ? `${L}（全餐）` : String(L);
      lN.appendChild(opt);
    }

    const next = (prev >= minL && prev <= maxL) ? prev : minL;
    lN.value = String(next);
  }

  // ✅ Banker hit dropdown (combined bw+be) built from b
  // value format: "bw|be"
  function describeBankerHit(bw, be){
    if(bw===0 && be===0) return "沒有中膽";
    if(bw===0 && be===1) return "中特別號碼";
    if(be===1) return `中${bw}個號碼+特別號碼`;
    return `中${bw}個號碼`;
  }

  function populateBankerHitOptions(){
    const b = parseInt(bN.value, 10);
    const prev = bankerHitEl.value || "";

    const options = [];

    // be=0: bw 0..b
    for(let bw=0; bw<=b; bw++){
      options.push({ bw, be:0, label: describeBankerHit(bw, 0) });
    }
    // be=1: bw 0..b-1 (because extra occupies 1 banker slot)
    for(let bw=0; bw<=Math.max(0, b-1); bw++){
      options.push({ bw, be:1, label: describeBankerHit(bw, 1) });
    }

    // Sort like: higher total-hit first, and be=1 before be=0 when same total-hit
    options.sort((a1,a2)=>{
      const t1 = a1.bw + a1.be;
      const t2 = a2.bw + a2.be;
      if(t2!==t1) return t2-t1;
      if(a2.be!==a1.be) return a2.be-a1.be;
      return a2.bw-a1.bw;
    });

    bankerHitEl.innerHTML = "";
    for(const o of options){
      const opt = document.createElement("option");
      opt.value = `${o.bw}|${o.be}`;
      opt.textContent = o.label;
      bankerHitEl.appendChild(opt);
    }

    // keep previous if possible
    const found = options.some(o => `${o.bw}|${o.be}` === prev);
    bankerHitEl.value = found ? prev : options[0].value;

    const t = 6 - b;
    bankerHitHintEl.textContent = `每注：${b}膽 + ${t}腳。此下拉式只描述「膽」命中情況，系統會在下表自動列出所有「腳」命中組合。`;
  }

  function getBankerHit(){
    const v = bankerHitEl.value || "0|0";
    const [bwS, beS] = v.split("|");
    const bw = parseInt(bwS,10);
    const be = parseInt(beS,10);
    return { bw, be };
  }

  function calcBetsAndStake(){
    const u = unitStake();
    warnEl.textContent="";

    let bets=0;
    if(type==="single"){
      bets = 1;
    } else if(type==="multiple"){
      const n = parseInt(mulN.value,10);
      bets = choose(n,6);
      mulHint.textContent = `注數 = C(${n},6) = ${bets.toLocaleString("en-US")}`;
      if(n>=25){
        warnEl.innerHTML = `<span class="warn">提示：</span>複式 ${n} 個號碼的注數較大，投注額會非常高。`;
      }
    } else {
      const b = parseInt(bN.value,10);
      const L = parseInt(lN.value,10);
      const t = 6 - b;

      if(b + L < 7 || b + L > 49){
        warnEl.innerHTML = `<span class="warn">錯誤：</span>膽+腳必須介乎 7–49。`;
        betsPill.textContent = `注數：—`;
        stakePill.textContent = `投注額：—`;
        return null;
      }
      bets = choose(L, t);
    }

    betsPill.textContent = `注數：${bets.toLocaleString("en-US")}`;
    stakePill.textContent = `投注額：${fmtMoney(bets*u)}`;
    return bets;
  }

  function renderRows(rows){
    if(!rows || rows.length===0){
      return `<div class="muted">在目前設定下，未有任何「有派彩」的命中情境（或參數不合理）。</div>`;
    }

    const trs = rows.map(r=>{
      const unitsText = summarizeUnits(r.units) || "—";
      const fixedText = (r.fixed && r.fixed > 0) ? fmtMoney(r.fixed) : "—";
      const note = r.topNote ? `<div class="muted" style="margin-top:4px;">${r.topNote}</div>` : "";

      return `
        <tr>
          <td style="width:38%"><strong>${r.label}</strong></td>
          <td style="width:40%">${unitsText}</td>
          <td class="nowrap" style="width:22%">${fixedText}${note}</td>
        </tr>
      `;
    }).join("");

    return `
      <table>
        <thead>
          <tr>
            <th>命中情境</th>
            <th>中獎份數</th>
            <th>固定獎金</th>
          </tr>
        </thead>
        <tbody>${trs}</tbody>
      </table>
    `;
  }

  function renderAll(){
    syncPanels();

    // keep banker hit options synced with b
    if(type==="banker"){
      populateBankerHitOptions();
    }

    const betsOk = calcBetsAndStake();
    if(betsOk===null){ outEl.innerHTML=""; return; }

    const sr = stakeRatio();
    let rows=[];

    if(type==="single"){
      rows = listSingleScenarios(sr);
      outEl.innerHTML = renderRows(rows);
      return;
    }
    if(type==="multiple"){
      const n = parseInt(mulN.value,10);
      rows = listMultipleScenarios(n, sr);
      outEl.innerHTML = renderRows(rows);
      return;
    }

    // banker
    const b = parseInt(bN.value,10);
    const L = parseInt(lN.value,10);
    const { bw, be } = getBankerHit();

    // safety: bw+be <= b (always true with our options)
    rows = listBankerRows(b, L, bw, be, sr);
    outEl.innerHTML = renderRows(rows);
  }

  // ---------- init ----------
  (function init(){
    // multiple n 7..49
    for(let n=7;n<=49;n++){
      const opt=document.createElement("option");
      opt.value=String(n);
      opt.textContent=String(n);
      mulN.appendChild(opt);
    }
    mulN.value="7";

    // banker b 1..5
    for(let b=1;b<=5;b++){
      const opt=document.createElement("option");
      opt.value=String(b);
      opt.textContent=String(b);
      bN.appendChild(opt);
    }
    bN.value="2";

    populateLegOptions();
    populateBankerHitOptions();

    renderAll();
  })();

  // ---------- events ----------
  typeEls.forEach(r=>{
    r.addEventListener("change", ()=>{
      if(r.checked){
        type=r.value;
        // ensure banker dropdowns are valid when switching in
        if(type==="banker"){
          populateLegOptions();
          populateBankerHitOptions();
        }
        renderAll();
      }
    });
  });

  halfEl.addEventListener("change", renderAll);
  mulN.addEventListener("change", renderAll);

  bN.addEventListener("change", ()=>{
    populateLegOptions();          // legs range depends on b
    populateBankerHitOptions();    // banker-hit options depend on b
    renderAll();
  });

  lN.addEventListener("change", renderAll);

  bankerHitEl.addEventListener("change", renderAll);

  document.getElementById("calc").addEventListener("click", renderAll);
</script>
</body>
</html>
