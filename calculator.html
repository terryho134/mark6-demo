<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>注數及獎金計算機｜Mark6</title>
  <style>
    body { font-family: system-ui, -apple-system, "PingFang HK", "Noto Sans TC", Arial, sans-serif; margin: 24px; line-height: 1.55; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; }
    .muted { color:#666; font-size:14px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f3f3; font-size:13px; margin-right:6px; }
    select, input, button { padding:8px 10px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-top:1px solid #eee; padding:10px 8px; vertical-align:top; text-align:left; }
    th { background:#fafafa; font-weight:600; }
    .warn { color:#b00020; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
    hr { border:none; border-top:1px solid #eee; margin:14px 0; }
    .nowrap { white-space: nowrap; }
    .subcard { border:1px dashed #ddd; border-radius:10px; padding:12px; margin:10px 0; background:#fcfcfc; }
  </style>
</head>
<body>
  <h1>注數及獎金計算機</h1>
  <p class="muted">
    輸入下注方式與數量（複式/膽拖），列出「所有命中情境」下各獎項中獎份數，以及四至七獎固定獎金（按全注/半注比例）。
    頭/二/三獎派彩浮動，本頁只顯示份數提示。
  </p>

  <div class="card">
    <h3 style="margin-top:0;">1) 下注方式</h3>
    <div class="row">
      <label><input type="radio" name="type" value="single" checked> 單式</label>
      <label><input type="radio" name="type" value="multiple"> 複式</label>
      <label><input type="radio" name="type" value="banker"> 膽拖</label>

      <label style="margin-left:auto;">
        半注（$5）
        <input id="half" type="checkbox">
      </label>
    </div>

    <hr>

    <div id="panelSingle" class="row">
      <span class="muted">單式固定 1 注（6 個號碼）。</span>
    </div>

    <div id="panelMultiple" style="display:none;">
      <div class="row">
        <label>複式號碼數</label>
        <select id="mulN"></select>
        <span class="muted">（7–49）</span>
      </div>
      <div class="muted" id="mulHint" style="margin-top:6px;"></div>
    </div>

    <div id="panelBanker" style="display:none;">
      <div class="row">
        <label>膽數</label>
        <select id="bN"></select>

        <label>腳數</label>
        <select id="lN"></select>

        <span class="muted">（總數 7–49；最大值為「全餐」）</span>
      </div>
      <div class="muted" style="margin-top:6px;">
        提示：膽拖的「中膽情況」已移到下方「所有命中情境」卡內。
      </div>
    </div>

    <hr>

    <div class="row">
      <span class="pill" id="betsPill">注數：—</span>
      <span class="pill" id="stakePill">投注額：—</span>
      <span id="warn" class="muted"></span>
      <button id="calc" style="margin-left:auto;">更新</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">2) 所有命中情境（只顯示有派彩）</h3>

    <!-- Banker layer2 moved here -->
    <div id="bankerLayer2" class="subcard" style="display:none;">
      <div class="row">
        <span class="pill">膽拖：中膽情況</span>
        <label>命中膽（正選/特別號）</label>
        <select id="bankerHit"></select>
      </div>
      <div class="muted" id="bankerHitHint" style="margin-top:6px;"></div>
    </div>

    <div id="out"></div>

    <div class="muted" style="margin-top:10px;">
      固定獎金（以全注 $10 為基準）：四獎 $9,600｜五獎 $640｜六獎 $320｜七獎 $40（半注按比例減半）。
    </div>
  </div>

  <p><a href="/">返回首頁</a>　｜　<a href="/checker.html">到核對器</a></p>

<script>
  // ---------- helpers ----------
  function fmtMoney(n){ return "HK$ " + Number(n).toLocaleString("en-US"); }

  function choose(n,k){
    if(k<0||n<0||k>n) return 0;
    k=Math.min(k,n-k);
    let r=1;
    for(let i=1;i<=k;i++) r=(r*(n-(k-i)))/i;
    return Math.round(r);
  }

  const PRIZE = { div4:9600, div5:640, div6:320, div7:40 };

  function fixedTotal(units, stakeRatio){
    const t = units.div4*PRIZE.div4 + units.div5*PRIZE.div5 + units.div6*PRIZE.div6 + units.div7*PRIZE.div7;
    return Math.round(t * stakeRatio);
  }

  function summarizeUnits(units){
    const map = [
      ["div1","頭獎"],["div2","二獎"],["div3","三獎"],
      ["div4","四獎"],["div5","五獎"],["div6","六獎"],["div7","七獎"]
    ];
    const parts=[];
    for(const [k,name] of map){
      const v = units[k]||0;
      if(v>0) parts.push(`${name}×${v.toLocaleString("en-US")}`);
    }
    return parts.join("，");
  }

  function hasAnyPrize(units){
    return (units.div1+units.div2+units.div3+units.div4+units.div5+units.div6+units.div7) > 0;
  }

  // ---------- scenarios (count-based) ----------
  function unitsFromXYZN(x,y,z){
    const div1 = choose(x, 6);
    const div2 = y * choose(x, 5);
    const div3 = choose(x, 5) * choose(z, 1);
    const div4 = y * choose(x, 4) * choose(z, 1);
    const div5 = choose(x, 4) * choose(z, 2);
    const div6 = y * choose(x, 3) * choose(z, 2);
    const div7 = choose(x, 3) * choose(z, 3);
    return { div1, div2, div3, div4, div5, div6, div7 };
  }

  function listSingleScenarios(stakeRatio){
    const rows=[];
    const n=6;
    for(let x=0;x<=6;x++){
      for(let y=0;y<=1;y++){
        if(x+y>6) continue;
        if(x===6 && y===1) continue;
        const z = n - x - y;
        const units = unitsFromXYZN(x,y,z);
        if(!hasAnyPrize(units)) continue;

        rows.push({
          label: `命中：中${x}個正選${y===1 ? " + 特別號" : ""}`,
          units,
          fixed: fixedTotal(units, stakeRatio),
          topNote: (units.div1+units.div2+units.div3)>0 ? "頭/二/三獎派彩屬浮動（以官方 Unit Prize 為準）" : ""
        });
      }
    }
    rows.sort((a,b)=>{
      const score = (r)=> (r.units.div1*1e9 + r.units.div2*1e7 + r.units.div3*1e5 + r.fixed);
      return score(b)-score(a);
    });
    return rows;
  }

  function listMultipleScenarios(n, stakeRatio){
    const rows=[];
    for(let x=0;x<=Math.min(6,n);x++){
      for(let y=0;y<=1;y++){
        if(x+y>n) continue;
        if(x===6 && y===1) continue;
        const z = n - x - y;
        const units = unitsFromXYZN(x,y,z);
        if(!hasAnyPrize(units)) continue;

        rows.push({
          label:`命中：中${x}個正選${y===1 ? " + 特別號" : ""}`,
          units,
          fixed: fixedTotal(units, stakeRatio),
          topNote: (units.div1+units.div2+units.div3)>0 ? "頭/二/三獎派彩屬浮動（以官方 Unit Prize 為準）" : ""
        });
      }
    }
    rows.sort((a,b)=>{
      const getM = (s)=> (s.match(/中(\d+)個正選/)||[])[1] ? Number((s.match(/中(\d+)個正選/)||[])[1]) : 0;
      const ma=getM(a.label), mb=getM(b.label);
      if(mb!==ma) return mb-ma;
      const ea=a.label.includes("特別號")?1:0;
      const eb=b.label.includes("特別號")?1:0;
      if(eb!==ea) return eb-ea;
      return (b.fixed||0)-(a.fixed||0);
    });
    return rows;
  }

  function calcBankerUnitsFromCounts(b, L, bw, be, lw, le){
    const t = 6 - b;
    const lo = L - lw - le;
    if(lo < 0) return null;

    const units = { div1:0, div2:0, div3:0, div4:0, div5:0, div6:0, div7:0 };

    for(let k=0; k<=Math.min(lw, t); k++){
      for(let u=0; u<=Math.min(le, t-k); u++){
        const r = t - k - u;
        if(r<0 || r>lo) continue;

        const m = bw + k;
        const e = (be===1) ? 1 : u;
        const ways = choose(lw, k) * choose(le, u) * choose(lo, r);

        if(m===6) units.div1 += ways;
        else if(m===5 && e===1) units.div2 += ways;
        else if(m===5 && e===0) units.div3 += ways;
        else if(m===4 && e===1) units.div4 += ways;
        else if(m===4 && e===0) units.div5 += ways;
        else if(m===3 && e===1) units.div6 += ways;
        else if(m===3 && e===0) units.div7 += ways;
      }
    }
    return { units };
  }

  // feasibility filter to hide impossible rows when legs are large (e.g., full meal)
  function isFeasibleBankerCounts(b, L, bw, be, lw, le){
    const NNB = 49 - b;          // non-banker total
    const U = NNB - L;           // non-banker NOT picked (outside legs)
    const remMain = 6 - bw;      // winning mains not in bankers (must be among non-bankers)

    if (lw < 0) return false;
    if (lw > Math.min(L, remMain)) return false;

    const wu = remMain - lw;     // winning mains outside legs
    if (wu < 0 || wu > U) return false;

    if (be === 1) {
      if (le !== 0) return false; // extra already in bankers => not in legs
      const otherCount = NNB - remMain; // other non-bankers besides the remMain winning mains
      const lo = L - lw;
      if (lo < 0 || lo > otherCount) return false;
      return true;
    }

    // be === 0
    if (le !== 0 && le !== 1) return false;

    const extraOutside = (le === 0) ? 1 : 0;
    if (wu + extraOutside > U) return false;

    // if U==0 (full meal among non-bankers), extra cannot be outside legs
    if (U === 0 && le === 0) return false;

    const otherCount = NNB - remMain - 1; // exclude remMain winning mains and the extra
    const lo = L - lw - le;
    if (lo < 0 || lo > otherCount) return false;

    return true;
  }

  function describeBankerHit(bw, be){
    if(bw===0 && be===0) return "沒有中膽";
    if(bw===0 && be===1) return "命中特別號碼";
    if(be===1) return `命中${bw}個號碼+特別號碼`;
    return `命中${bw}個號碼`;
  }

  function listBankerRows(b, L, bw, be, stakeRatio){
    const rows=[];
    const NNB = 49 - b;
    const U = NNB - L;
    const remMain = 6 - bw;

    // lw bounds tightened by U
    const lwMin = Math.max(0, remMain - U);
    const lwMax = Math.min(L, remMain);

    let leOptions = [];
    if (be === 1) leOptions = [0];
    else leOptions = (U === 0) ? [1] : [0,1];

    for(let lw = lwMin; lw <= lwMax; lw++){
      for(const le of leOptions){
        if(!isFeasibleBankerCounts(b, L, bw, be, lw, le)) continue;

        const out = calcBankerUnitsFromCounts(b, L, bw, be, lw, le);
        if(!out) continue;
        if(!hasAnyPrize(out.units)) continue;

        function describeLegHit(lw, le){
          if(lw===0 && le===0) return "沒有命中";
          if(lw===0 && le===1) return "命中特別號碼";
          if(lw>0 && le===1) return `命中${lw}個號碼+特別號碼`;
          return `命中${lw}個號碼`;
        }

        const m = bw + lw;
        const e = (be===1 || le===1);
        
        const label = [
          `膽：${describeBankerHit(bw, be)}`,
          `腳：${describeLegHit(lw, le)}`,                // ✅ 新格式
        ].join("｜");


        rows.push({
          label,
          units: out.units,
          fixed: fixedTotal(out.units, stakeRatio),
          topNote: (out.units.div1+out.units.div2+out.units.div3)>0
            ? "頭/二/三獎派彩屬浮動（以官方 Unit Prize 為準）"
            : "",
          _m: m,    // ✅ hidden sort key
          _e: e     // ✅ hidden sort key
        });
      }
    }

    rows.sort((a,b)=>{
      // 先排「總命中正選數」(m) 由大到細（雖然唔顯示，但最符合常識）
      if((b._m||0) !== (a._m||0)) return (b._m||0) - (a._m||0);
    
      // 再排有冇特別號（e=1 排前）
      if((b._e||0) !== (a._e||0)) return (b._e||0) - (a._e||0);
    
      // 再排固定獎金高低
      return (b.fixed||0) - (a.fixed||0);
    });


    return rows;
  }

  // ---------- UI ----------
  const typeEls = Array.from(document.querySelectorAll('input[name="type"]'));
  const halfEl = document.getElementById("half");
  const panelSingle = document.getElementById("panelSingle");
  const panelMultiple = document.getElementById("panelMultiple");
  const panelBanker = document.getElementById("panelBanker");

  const mulN = document.getElementById("mulN");
  const mulHint = document.getElementById("mulHint");

  const bN = document.getElementById("bN");
  const lN = document.getElementById("lN");

  const bankerLayer2 = document.getElementById("bankerLayer2");
  const bankerHitEl = document.getElementById("bankerHit");
  const bankerHitHintEl = document.getElementById("bankerHitHint");

  const betsPill = document.getElementById("betsPill");
  const stakePill = document.getElementById("stakePill");
  const warnEl = document.getElementById("warn");
  const outEl = document.getElementById("out");

  let type="single";

  function unitStake(){ return halfEl.checked ? 5 : 10; }
  function stakeRatio(){ return halfEl.checked ? 0.5 : 1; }

  function syncPanels(){
    panelSingle.style.display = (type==="single") ? "" : "none";
    panelMultiple.style.display = (type==="multiple") ? "" : "none";
    panelBanker.style.display = (type==="banker") ? "" : "none";
    bankerLayer2.style.display = (type==="banker") ? "" : "none";
  }

  function populateLegOptions(){
    const b = parseInt(bN.value, 10);
    const minL = Math.max(7 - b, 1);
    const maxL = 49 - b;

    const prev = parseInt(lN.value || "0", 10);
    lN.innerHTML = "";

    for(let L=minL; L<=maxL; L++){
      const opt = document.createElement("option");
      opt.value = String(L);
      opt.textContent = (L === maxL) ? `${L}（全餐）` : String(L);
      lN.appendChild(opt);
    }

    const next = (prev >= minL && prev <= maxL) ? prev : minL;
    lN.value = String(next);
  }

  // banker hit dropdown combined bw+be, sorted as requested
  // value format: "bw|be"
  function populateBankerHitOptions(){
    const b = parseInt(bN.value, 10);
    const prev = bankerHitEl.value || "";

    const opts = [];

    // be=0: bw 0..b
    for(let bw=0; bw<=b; bw++){
      opts.push({ bw, be:0, label: describeBankerHit(bw, 0) });
    }
    // be=1: bw 0..b-1
    for(let bw=0; bw<=Math.max(0, b-1); bw++){
      opts.push({ bw, be:1, label: describeBankerHit(bw, 1) });
    }

    // ✅ order: bw desc, within same bw: be=1 first, finally (0,1) before (0,0) naturally
    opts.sort((a,b2)=>{
      if(b2.bw !== a.bw) return b2.bw - a.bw;
      if(b2.be !== a.be) return b2.be - a.be;
      return 0;
    });

    bankerHitEl.innerHTML = "";

    // placeholder: must choose
    {
      const o = document.createElement("option");
      o.value = "";
      o.textContent = "請選擇中膽情況…";
      bankerHitEl.appendChild(o);
    }

    for(const o of opts){
      const opt = document.createElement("option");
      opt.value = `${o.bw}|${o.be}`;
      opt.textContent = o.label;
      bankerHitEl.appendChild(opt);
    }

    const found = opts.some(o => `${o.bw}|${o.be}` === prev);
    bankerHitEl.value = found ? prev : "";

    const t = 6 - b;
    bankerHitHintEl.textContent = `每注：${b}膽 + ${t}腳。此下拉式描述「膽」命中情況；系統會自動列出所有「腳」命中組合（並隱藏不可能出現的列）。`;
  }

  function getBankerHit(){
    const v = (bankerHitEl.value || "").trim();
    if(!v) return null;
    const [bwS, beS] = v.split("|");
    return { bw: parseInt(bwS,10), be: parseInt(beS,10) };
  }

  function calcBetsAndStake(){
    const u = unitStake();
    warnEl.textContent = "";

    let bets=0;

    if(type==="single"){
      bets = 1;
    } else if(type==="multiple"){
      const n = parseInt(mulN.value,10);
      bets = choose(n,6);
      mulHint.textContent = `注數 = C(${n},6) = ${bets.toLocaleString("en-US")}`;
      if(n>=25){
        warnEl.innerHTML = `<span class="warn">提示：</span>複式 ${n} 個號碼的注數較大，投注額會非常高。`;
      }
    } else {
      const b = parseInt(bN.value,10);
      const L = parseInt(lN.value,10);
      const t = 6 - b;

      if(b + L < 7 || b + L > 49){
        warnEl.innerHTML = `<span class="warn">錯誤：</span>膽+腳必須介乎 7–49。`;
        betsPill.textContent = `注數：—`;
        stakePill.textContent = `投注額：—`;
        return null;
      }

      bets = choose(L, t);
    }

    betsPill.textContent = `注數：${bets.toLocaleString("en-US")}`;
    stakePill.textContent = `投注額：${fmtMoney(bets*u)}`;
    return bets;
  }

  function renderRows(rows){
    if(!rows || rows.length===0){
      return `<div class="muted">在目前設定下，未有任何「有派彩」的命中情境（或參數不合理）。</div>`;
    }

    const trs = rows.map(r=>{
      const unitsText = summarizeUnits(r.units) || "—";
      const fixedText = (r.fixed && r.fixed > 0) ? fmtMoney(r.fixed) : "—";
      const note = r.topNote ? `<div class="muted" style="margin-top:4px;">${r.topNote}</div>` : "";

      return `
        <tr>
          <td style="width:38%"><strong>${r.label}</strong></td>
          <td style="width:40%">${unitsText}</td>
          <td class="nowrap" style="width:22%">${fixedText}${note}</td>
        </tr>
      `;
    }).join("");

    return `
      <table>
        <thead>
          <tr>
            <th>命中情境</th>
            <th>中獎份數</th>
            <th>固定獎金</th>
          </tr>
        </thead>
        <tbody>${trs}</tbody>
      </table>
    `;
  }

  function renderAll(){
    syncPanels();

    if(type==="banker"){
      // keep banker dropdown synced with current b
      populateBankerHitOptions();
    }

    const betsOk = calcBetsAndStake();
    if(betsOk === null){
      outEl.innerHTML = "";
      return;
    }

    const sr = stakeRatio();

    if(type==="single"){
      outEl.innerHTML = renderRows(listSingleScenarios(sr));
      return;
    }

    if(type==="multiple"){
      const n = parseInt(mulN.value,10);
      outEl.innerHTML = renderRows(listMultipleScenarios(n, sr));
      return;
    }

    // banker
    const b = parseInt(bN.value,10);
    const L = parseInt(lN.value,10);
    const hit = getBankerHit();

    if(!hit){
      outEl.innerHTML = `<div class="muted">請先選擇「中膽情況」，系統才會列出所有命中情境。</div>`;
      return;
    }

    outEl.innerHTML = renderRows(listBankerRows(b, L, hit.bw, hit.be, sr));
  }

  // ---------- init ----------
  (function init(){
    // multiple n 7..49
    for(let n=7;n<=49;n++){
      const opt=document.createElement("option");
      opt.value=String(n);
      opt.textContent=String(n);
      mulN.appendChild(opt);
    }
    mulN.value="7";

    // banker b 1..5
    for(let b=1;b<=5;b++){
      const opt=document.createElement("option");
      opt.value=String(b);
      opt.textContent=String(b);
      bN.appendChild(opt);
    }
    bN.value="2";

    populateLegOptions();
    populateBankerHitOptions();

    renderAll();
  })();

  // ---------- events ----------
  typeEls.forEach(r=>{
    r.addEventListener("change", ()=>{
      if(!r.checked) return;
      type = r.value;

      if(type==="banker"){
        populateLegOptions();
        populateBankerHitOptions();
      }

      renderAll();
    });
  });

  halfEl.addEventListener("change", renderAll);
  mulN.addEventListener("change", renderAll);

  bN.addEventListener("change", ()=>{
    populateLegOptions();
    populateBankerHitOptions();
    renderAll();
  });

  lN.addEventListener("change", renderAll);
  bankerHitEl.addEventListener("change", renderAll);

  document.getElementById("calc").addEventListener("click", renderAll);
</script>
</body>
</html>
