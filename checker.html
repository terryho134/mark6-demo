<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>中獎核對器｜Mark6</title>
  <style>
    body { font-family: system-ui, -apple-system, "PingFang HK", "Noto Sans TC", Arial, sans-serif; margin: 24px; line-height: 1.55; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; }
    .muted { color:#666; font-size:14px; }
    .error { color:#b00020; }
    .ok { color:#0a7a0a; }
    input[type="checkbox"]{ padding:0; width:18px; height:18px; }
    .grid { display:grid; grid-template-columns: repeat(10, minmax(0, 1fr)); gap:6px; }
    .nbtn { padding:8px 0; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer; }
    .nbtn.on { background:#111; color:#fff; border-color:#111; }
    .nbtn.bank { background:#0b57d0; color:#fff; border-color:#0b57d0; }
    .nbtn.leg { background:#111; color:#fff; border-color:#111; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
    hr { border:none; border-top:1px solid #eee; margin:14px 0; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f3f3; font-size:13px; margin-right:6px; }
  </style>
</head>
<body>
  <h1>中獎核對器</h1>
  <p class="muted">支援：單式／複式／膽拖。頭/二/三獎派彩屬浮動，本頁只顯示「中獎份數」與固定獎金（四至七獎）。</p>

  <div class="card">
    <h3 style="margin-top:0;">1) 選擇玩法</h3>
    <div class="row">
      <label><input type="radio" name="type" value="single" checked> 單式</label>
      <label><input type="radio" name="type" value="multiple"> 複式</label>
      <label><input type="radio" name="type" value="banker"> 膽拖</label>
    </div>

    <hr>

    <h3 style="margin-top:0;">2) 選擇/輸入號碼</h3>
    <p class="muted" id="ruleHint"></p>

    <div class="row">
      <button id="clear">清除</button>
      <span class="pill" id="chancesPill">份數：—</span>
      <span class="pill" id="stakePill">投注額：—</span>
      <label id="halfWrap" style="margin-left:auto; display:inline-flex; align-items:center; gap:6px;">
        <input id="half" type="checkbox">
        半注（$5）
      </label>


    </div>

    <div style="margin-top:10px;">
      <div class="grid" id="grid"></div>
    </div>

    <div style="margin-top:12px;">
      <div class="muted">已選內容（可貼入/修改）：</div>
      <input id="input" style="width:100%;" placeholder="單式/複式：以空格分隔；膽拖：膽(空格) > 腳(空格)" />
      <div class="muted" style="margin-top:6px;">
        顯示格式：單式/複式 <code>1 7 12 23 36 44</code>；膽拖 <code>1 7 > 12 23 36 44 49</code>
      </div>
      <div id="inputErr" class="error" style="margin-top:6px;"></div>
    </div>

    <hr>

    <h3 style="margin-top:0;">3) 選填攪珠日期或期數</h3>
    <div class="row">
      <label>攪珠日期</label>
      <input id="drawDate" type="date" />

      <span class="muted">或</span>

      <label>期數</label>
      <select id="year"></select>
      <input id="seq" type="number" min="1" max="200" placeholder="例如 18" style="width:110px;">
      <span class="muted">→</span>
      <input id="drawNo" readonly placeholder="YY/XXX" style="width:100px;">
      <button id="clearDraw">清除期數/日期</button>
    </div>
    <div class="row" style="margin-top:10px;">
      <label>
        <input id="multiMode" type="checkbox">
        多期核對
      </label>
    
      <div id="multiControls" style="display:none;" class="row">
        <span class="muted">由</span>
        <select id="multiYear"></select>
        <select id="multiSeq"></select>
        <span class="muted">起，核對</span>
        <select id="multiCount">
          <option value="5">5期</option>
          <option value="10">10期</option>
          <option value="20">20期</option>
          <option value="30" selected>30期</option>
        </select>
        <span class="muted">（開始期：</span><input id="startDrawNo" readonly style="width:100px;" placeholder="YY/XXX"><span class="muted">）</span>
      </div>
    </div>

    <div class="muted">如同時填日期及期數，本頁會以 <strong>期數</strong> 優先。</div>

    <hr>

    <h3 style="margin-top:0;">4) 核對</h3>
    <div class="row">
      <button id="check">核對</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="card" id="resultCard" style="display:none;">
    <h3 style="margin:0;">結果</h3>

    <label id="rangeWrap" class="muted" style="margin-left:12px;">
      核對範圍：
      <select id="rangePreset">
        <option value="60days" selected>近60日</option>
        <option value="30draws">近30期</option>
        <option value="60draws">近60期</option>
      </select>
    </label>
    
    <label id="halfResultWrap" style="display:inline-flex; align-items:center; gap:6px;">
      <input id="halfResult" type="checkbox">
      半注（$5）
    </label>
  
    <div id="mainResult" style="margin-top:10px;"></div>
    <div id="recentBlock" style="margin-top:14px;"></div>
  </div>


  <p><a href="/">返回首頁</a></p>

<script>
  // -------------------------
  // Helpers
  // -------------------------
  async function fetchJsonNoStore(url, fetchInit = {}) {
    const u = new URL(url, location.origin);
    // bust browser cache; edge cache key ignores __ts via canonicalizeUrl
    u.searchParams.set("__ts", Date.now().toString());

    const res = await fetch(u.toString(), {
      cache: "no-store",
      headers: {
        "Cache-Control": "no-cache",
        "accept": "application/json",
        ...(fetchInit.headers || {})
      },
      ...fetchInit,
    });

    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      throw new Error(`API 回傳非 JSON（HTTP ${res.status}）。前 200 字：` + text.slice(0, 200));
    }
    return { res, data };
  }

  function toNum(x, fallback = 0) {
    const n = Number(x);
    return Number.isFinite(n) ? n : fallback;
  }

  function parseNumsAny(x) {
    if (Array.isArray(x)) return x.map((v) => toNum(v)).filter((n) => n >= 1 && n <= 49);
    if (typeof x === "string") {
      return x
        .split(/[^0-9]+/)
        .filter(Boolean)
        .map((v) => toNum(v))
        .filter((n) => n >= 1 && n <= 49);
    }
    return [];
  }

  function normalizeDraw(d) {
    const nums =
      parseNumsAny(d.numbersArr).length ? parseNumsAny(d.numbersArr) :
      parseNumsAny(d.numbers).length ? parseNumsAny(d.numbers) :
      parseNumsAny(d.numbersStr);

    const sp =
      Number.isFinite(Number(d.specialNo)) ? Number(d.specialNo) :
      Number.isFinite(Number(d.special)) ? Number(d.special) :
      Number.isFinite(Number(d.specialStr)) ? Number(d.specialStr) :
      0;

    return {
      drawNo: d.drawNo,
      drawDate: d.drawDate,
      numbers: nums,
      special: sp,
    };
  }

  // Normalize API check response shapes for rendering:
  // - draw numbers might be in draw.extra or draw.special
  // - recentWins list might have numbers as string/array
  function normalizeWinItem(w) {
    const nums =
      parseNumsAny(w.numbersArr).length ? parseNumsAny(w.numbersArr) :
      parseNumsAny(w.numbers).length ? parseNumsAny(w.numbers) :
      parseNumsAny(w.numbersStr);
  
    const extra = getExtraNo(w);
  
    // summary might be missing; derive from units if needed
    const summary =
      Array.isArray(w.summary) ? w.summary :
      deriveSummaryFromUnits(w.units);
  
    const fixedTotal =
      Number(w.fixedTotal ?? w.fixedAmount?.totalFixed ?? w.fixedAmount?.total ?? w.fixed) || 0;
  
    return {
      ...w,
      numbers: nums,
      extra,
      summary,
      fixedTotal,
    };
  }

  function getExtraNo(obj) {
    return (
      (Number.isFinite(Number(obj?.extra)) ? Number(obj.extra) : null) ??
      (Number.isFinite(Number(obj?.special)) ? Number(obj.special) : null) ??
      (Number.isFinite(Number(obj?.specialNo)) ? Number(obj.specialNo) : null) ??
      0
    );
  }
  
  function deriveSummaryFromUnits(units) {
    // units could be {div1..div7} or {1..7} or similar
    const u = units || {};
    const get = (k) => {
      if (u == null) return 0;
      if (Number.isFinite(Number(u[k]))) return Number(u[k]);
      return 0;
    };
  
    const mapping = [
      ["div1", "頭獎"],
      ["div2", "二獎"],
      ["div3", "三獎"],
      ["div4", "四獎"],
      ["div5", "五獎"],
      ["div6", "六獎"],
      ["div7", "七獎"],
    ];
  
    const out = [];
    for (const [k, name] of mapping) {
      const n = get(k);
      if (n > 0) out.push({ name, units: n });
    }
    return out;
  }
  
  function isAnyWinFromResult(r) {
    if (!r) return false;
    if (r.anyWin === true || r.hasWin === true || r.won === true) return true;
  
    const summary = Array.isArray(r.summary) ? r.summary : [];
    if (summary.length > 0) return true;
  
    const derived = deriveSummaryFromUnits(r.units);
    return derived.length > 0;
  }

  // -------------------------
  // DOM refs
  // -------------------------
  const rangeEl = document.getElementById("rangePreset");
  const rangeWrapEl = document.getElementById("rangeWrap");

  const multiModeEl = document.getElementById("multiMode");
  const multiControlsEl = document.getElementById("multiControls");
  const multiYearEl = document.getElementById("multiYear");
  const multiSeqEl = document.getElementById("multiSeq");
  const multiCountEl = document.getElementById("multiCount");
  const startDrawNoEl = document.getElementById("startDrawNo");

  const gridEl = document.getElementById("grid");
  const inputEl = document.getElementById("input");
  const inputErrEl = document.getElementById("inputErr");
  const ruleHintEl = document.getElementById("ruleHint");
  const chancesPill = document.getElementById("chancesPill");
  const stakePill = document.getElementById("stakePill");
  const halfEl = document.getElementById("half");
  const halfResultEl = document.getElementById("halfResult");
  const halfWrapEl = document.getElementById("halfWrap");
  const halfResultWrapEl = document.getElementById("halfResultWrap");

  const drawDateEl = document.getElementById("drawDate");
  const yearEl = document.getElementById("year");
  const seqEl = document.getElementById("seq");
  const drawNoEl = document.getElementById("drawNo");

  const statusEl = document.getElementById("status");
  const resultCard = document.getElementById("resultCard");
  const mainResultEl = document.getElementById("mainResult");
  const recentBlockEl = document.getElementById("recentBlock");

  const typeEls = Array.from(document.querySelectorAll('input[name="type"]'));

  // -------------------------
  // state
  // -------------------------
  let type = "single";
  let picks = new Set();
  let bankers = new Set();
  let legs = new Set();

  function updateHalfVisibility(){
    const show = (type !== "single"); // 單式：唔顯示半注
    if (!show) {
      halfEl.checked = false;
      if (halfResultEl) halfResultEl.checked = false;
    }
    if (halfWrapEl) halfWrapEl.style.display = show ? "inline-flex" : "none";
    if (halfResultWrapEl) halfResultWrapEl.style.display = show ? "inline-flex" : "none";
  }

  function updateRangeVisibility(){
    const hasSingleTarget = !!drawDateEl.value || !!drawNoEl.value;
    const isMulti = (multiModeEl ? multiModeEl.checked : false);
    const show = !hasSingleTarget && !isMulti;
    if (rangeWrapEl) rangeWrapEl.style.display = show ? "inline-flex" : "none";
  }

  function pad2(x){ return String(x).padStart(2,"0"); }
  function pad3(x){ return String(x).padStart(3,"0"); }
  function yyFromYear(y){ return pad2(Number(y)%100); }

  function buildDrawNoFromYearSeq(){
    const y = yearEl.value;
    const seq = parseInt(seqEl.value,10);
    if(!y || !Number.isFinite(seq) || seq<=0) { drawNoEl.value=""; return; }
    drawNoEl.value = `${yyFromYear(y)}/${pad3(seq)}`;
    updateRangeVisibility();
  }

  // years dropdown
  (function initYears(){
    const nowY = new Date().getFullYear();
    for(let y=2002; y<=nowY; y++){
      const opt=document.createElement("option");
      opt.value=String(y);
      opt.textContent=String(y);
      yearEl.appendChild(opt);
    }
    yearEl.value=String(nowY);
  })();

  (function initMulti(){
    const nowY = new Date().getFullYear();
    for(let y=2002; y<=nowY; y++){
      const opt=document.createElement("option");
      opt.value=String(y);
      opt.textContent=String(y);
      multiYearEl.appendChild(opt);
    }
    multiYearEl.value=String(nowY);

    for(let i=1;i<=200;i++){
      const opt=document.createElement("option");
      opt.value=String(i);
      opt.textContent=String(i).padStart(3,"0");
      multiSeqEl.appendChild(opt);
    }
    multiSeqEl.value="1";

    function buildStartDrawNo(){
      const y = multiYearEl.value;
      const s = parseInt(multiSeqEl.value,10);
      if(!y || !Number.isFinite(s) || s<=0){ startDrawNoEl.value=""; return; }
      startDrawNoEl.value = `${yyFromYear(y)}/${pad3(s)}`;
    }

    multiYearEl.addEventListener("change", buildStartDrawNo);
    multiSeqEl.addEventListener("change", buildStartDrawNo);
    buildStartDrawNo();
  })();

  function setMultiMode(on){
    multiControlsEl.style.display = on ? "flex" : "none";

    drawDateEl.disabled = on;
    yearEl.disabled = on;
    seqEl.disabled = on;
    document.getElementById("clearDraw").disabled = on;

    if (on) {
      drawDateEl.value="";
      seqEl.value="";
      drawNoEl.value="";
      updateRangeVisibility();
    }
  }

  if (multiModeEl) {
    multiModeEl.addEventListener("change", ()=>{
      setMultiMode(multiModeEl.checked);
      updateRangeVisibility();
    });
  }

  yearEl.addEventListener("change", buildDrawNoFromYearSeq);
  seqEl.addEventListener("input", buildDrawNoFromYearSeq);
  drawDateEl.addEventListener("change", updateRangeVisibility);

  document.getElementById("clearDraw").addEventListener("click", ()=>{
    drawDateEl.value="";
    seqEl.value="";
    drawNoEl.value="";
    updateRangeVisibility();
  });

  // range + multiCount change should re-check (NOT inside buildQuery)
  if (rangeEl) {
    rangeEl.addEventListener("change", ()=>{
      if(resultCard.style.display !== "none") runCheck();
    });
  }
  if (multiCountEl) {
    multiCountEl.addEventListener("change", ()=>{
      if(resultCard.style.display !== "none") runCheck();
    });
  }

  // grid buttons 1..49
  function makeGrid(){
    gridEl.innerHTML="";
    for(let i=1;i<=49;i++){
      const b=document.createElement("button");
      b.type="button";
      b.className="nbtn";
      b.textContent=String(i).padStart(2,"0");
      b.dataset.n=String(i);
      b.addEventListener("click", ()=>toggleNumber(i));
      gridEl.appendChild(b);
    }
  }
  makeGrid();

  function setType(newType){
    type=newType;
    picks=new Set(); bankers=new Set(); legs=new Set();
    inputEl.value="";
    inputErrEl.textContent="";
    updateHint();
    renderGrid();
    updateChancesStake();
    updateHalfVisibility();
  }

  function updateHint(){
    if(type==="single") ruleHintEl.textContent="單式：必須選 6 個號碼。";
    if(type==="multiple") ruleHintEl.textContent="複式：最少 7 個號碼。";
    if(type==="banker") ruleHintEl.textContent="膽拖：先點「膽」(最多 5 個)，再點「腳」。總數需 ≥7。";
  }

  typeEls.forEach(r=>{
    r.addEventListener("change", ()=>{
      if(r.checked) setType(r.value);
    });
  });

  function toggleNumber(n){
    if(type==="single" || type==="multiple"){
      if(picks.has(n)) picks.delete(n);
      else picks.add(n);
      syncInputFromState();
      renderGrid();
      updateChancesStake();
      return;
    }

    // banker mode: off -> banker -> leg -> off
    if(bankers.has(n)){
      bankers.delete(n);
      legs.add(n);
    } else if(legs.has(n)){
      legs.delete(n);
    } else {
      if(bankers.size < 5) bankers.add(n);
      else legs.add(n);
    }
    for(const x of bankers) if(legs.has(x)) legs.delete(x);

    syncInputFromState();
    renderGrid();
    updateChancesStake();
  }

  function renderGrid(){
    const btns = gridEl.querySelectorAll(".nbtn");
    btns.forEach(b=>{
      const n = parseInt(b.dataset.n,10);
      b.classList.remove("on","bank","leg");
      if(type==="single" || type==="multiple"){
        if(picks.has(n)) b.classList.add("on");
      } else {
        if(bankers.has(n)) b.classList.add("bank");
        else if(legs.has(n)) b.classList.add("leg");
      }
    });
  }

  function syncInputFromState(){
    if(type==="single" || type==="multiple"){
      const arr = Array.from(picks).sort((a,b)=>a-b);
      inputEl.value = arr.join(" ");
      return;
    }
    const b = Array.from(bankers).sort((a,b)=>a-b).join(" ");
    const l = Array.from(legs).sort((a,b)=>a-b).join(" ");
    inputEl.value = (b || l) ? `${b} > ${l}`.trim() : "";
  }

  function parseInputToState(){
    const raw = (inputEl.value || "").trim();
    inputErrEl.textContent="";
    if(!raw){
      if(type==="single"||type==="multiple") picks=new Set();
      else { bankers=new Set(); legs=new Set(); }
      return true;
    }

    const numsFromPart = (s)=> s.trim().split(/[\s,，]+/).filter(Boolean).map(x=>parseInt(x,10)).filter(n=>Number.isFinite(n));

    if(type==="banker"){
      const parts = raw.split(">");
      const left = parts[0] ?? "";
      const right = parts[1] ?? "";
      const b = numsFromPart(left);
      const l = numsFromPart(right);

      const bset = new Set(b);
      const lset = new Set(l);
      for(const x of bset) if(lset.has(x)) lset.delete(x);

      bankers = new Set(Array.from(bset).filter(n=>n>=1 && n<=49));
      legs = new Set(Array.from(lset).filter(n=>n>=1 && n<=49));
      return validateAndShow(false);
    } else {
      const arr = numsFromPart(raw).filter(n=>n>=1 && n<=49);
      picks = new Set(arr);
      return validateAndShow(false);
    }
  }

  function choose(n,k){
    if(k<0||n<0||k>n) return 0;
    k=Math.min(k,n-k);
    let r=1;
    for(let i=1;i<=k;i++) r=(r*(n-(k-i)))/i;
    return Math.round(r);
  }

  function validateAndShow(showError=true){
    const half = (type==="single") ? false : halfEl.checked;
    const unitStake = half ? 5 : 10;

    if(type==="single"){
      if(picks.size!==6){
        if(showError) inputErrEl.textContent="單式需要剛好 6 個號碼。";
        updateChancesStake(0, unitStake);
        return false;
      }
      updateChancesStake(1, unitStake);
      return true;
    }

    if(type==="multiple"){
      if(picks.size<7){
        if(showError) inputErrEl.textContent="複式需要最少 7 個號碼。";
        updateChancesStake(0, unitStake);
        return false;
      }
      const chances = choose(picks.size,6);
      updateChancesStake(chances, unitStake);
      return true;
    }

    if(bankers.size<1 || bankers.size>5){
      if(showError) inputErrEl.textContent="膽拖：膽需要 1–5 個。";
      updateChancesStake(0, unitStake);
      return false;
    }
    if(bankers.size + legs.size < 7){
      if(showError) inputErrEl.textContent="膽拖：總數需 ≥ 7（膽 + 腳）。";
      updateChancesStake(0, unitStake);
      return false;
    }
    const t = 6 - bankers.size;
    if(legs.size < t){
      if(showError) inputErrEl.textContent=`膽拖：腳不足以補足 6 個號碼（需要至少 ${t} 個腳）。`;
      updateChancesStake(0, unitStake);
      return false;
    }
    const chances = choose(legs.size, t);
    updateChancesStake(chances, unitStake);
    return true;
  }

  function updateChancesStake(chances=null, unitStake=null){
    const half = (type==="single") ? false : halfEl.checked;
    const u = unitStake ?? (half ? 5 : 10);

    let c = chances;
    if(c===null){
      if(type==="single") c = (picks.size===6) ? 1 : 0;
      else if(type==="multiple") c = (picks.size>=7) ? choose(picks.size,6) : 0;
      else {
        const t = 6 - bankers.size;
        c = (bankers.size>=1 && bankers.size<=5 && legs.size>=t) ? choose(legs.size,t) : 0;
      }
    }

    chancesPill.textContent = `份數：${c ? c.toLocaleString("en-US") : "—"}`;
    stakePill.textContent = `投注額：${c ? "HK$ " + (c*u).toLocaleString("en-US") : "—"}`;
  }

  document.getElementById("clear").addEventListener("click", ()=>{
    picks=new Set(); bankers=new Set(); legs=new Set();
    inputEl.value="";
    inputErrEl.textContent="";
    renderGrid();
    updateChancesStake();
  });

  inputEl.addEventListener("input", ()=>{
    parseInputToState();
    renderGrid();
    updateChancesStake();
  });

  let syncingHalf = false;
  function syncHalfUI(from) {
    if (syncingHalf) return;
    syncingHalf = true;
    const v = from.checked;
    halfEl.checked = v;
    if (halfResultEl) halfResultEl.checked = v;
    syncingHalf = false;
  }

  halfEl.addEventListener("change", ()=>{
    syncHalfUI(halfEl);
    updateChancesStake();
    if(resultCard.style.display !== "none") runCheck();
  });

  if (halfResultEl) {
    halfResultEl.addEventListener("change", ()=>{
      syncHalfUI(halfResultEl);
      updateChancesStake();
      if(resultCard.style.display !== "none") runCheck();
    });
  }

  // -------------------------
  // IMPORTANT: make payload match API expected shape
  // -------------------------
  function buildScope(){
    // Multi mode first
    if (multiModeEl && multiModeEl.checked) {
      return {
        multi: true,
        startDrawNo: startDrawNoEl.value.trim(),
        multiCount: toNum(multiCountEl.value, 10) || 10,
      };
    }
  
    const drawNo = (drawNoEl.value || "").trim();
    const drawDate = (drawDateEl.value || "").trim();
  
    if (drawNo) return { drawNo };
    if (drawDate) return { drawDate };
  
    const rp = rangeEl ? rangeEl.value : "60days";
  
    // legacy-compatible expansion
    const legacy = {};
    if (rp === "60days") legacy.days = 60;
    if (rp === "30issues") legacy.issues = 30;
    if (rp === "60issues") legacy.issues = 60;
  
    return { rangePreset: rp, ...legacy };
  }


  function buildTicket(){
    const half = (type==="single") ? false : !!halfEl.checked;

    if(type==="single"){
      return { type: "single", half, picks: Array.from(picks).sort((a,b)=>a-b) };
    }
    if(type==="multiple"){
      return { type: "multiple", half, picks: Array.from(picks).sort((a,b)=>a-b) };
    }
    return {
      type: "banker",
      half,
      bankers: Array.from(bankers).sort((a,b)=>a-b),
      legs: Array.from(legs).sort((a,b)=>a-b),
    };
  }

  function buildApiPayload(){
    const ticket = buildTicket();
    const scope = buildScope();
  
    const picksArr = Array.isArray(ticket.picks) ? ticket.picks : [];
    const bankersArr = Array.isArray(ticket.bankers) ? ticket.bankers : [];
    const legsArr = Array.isArray(ticket.legs) ? ticket.legs : [];
  
    const bets =
      ticket.type === "banker"
        ? [{ type: "banker", bankers: bankersArr, others: legsArr }]
        : ticket.type === "multiple"
        ? [{ type: "multiple", numbers: picksArr }]
        : [{ type: "single", numbers: picksArr }];
  
    return {
      // Newer shape
      bets,
      half: !!ticket.half,
      scope,
  
      // Legacy flat keys (what many older check.js expect)
      type: ticket.type,
      halfBet: !!ticket.half,       // extra alias
      picks: picksArr,
      numbers: picksArr,            // extra alias
      nums: picksArr,               // extra alias
      bankers: bankersArr,
      legs: legsArr,
      others: legsArr,              // banker alias
  
      // Legacy nested object (some versions expect ticket: {...})
      ticket: {
        type: ticket.type,
        half: !!ticket.half,
        picks: picksArr,
        numbers: picksArr,
        nums: picksArr,
        bankers: bankersArr,
        legs: legsArr,
        others: legsArr,
      },
  
      // Query/scope keys (legacy + new)
      ...scope,
    };
  }

  function fmtYMD(ymd){
    if(!ymd) return "";
    const m = String(ymd).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return ymd;
    return `${m[1]}年${m[2]}月${m[3]}日`;
  }

  function renderMain(main){
    const dRaw = main?.draw || {};
    const dNumbers = parseNumsAny(dRaw.numbers).length ? parseNumsAny(dRaw.numbers) : (dRaw.numbers || []);
    const dExtra = getExtraNo(dRaw);
  
    const t = main?.ticket || {};
    const r = main?.result || {};
  
    const hit = r.bestHit;
    const hitText = hit ? `命中：${hit.main}個正選${hit.extra ? " + 特別號" : ""}` : "";
  
    // summary fallback
    const summary = Array.isArray(r.summary) ? r.summary : deriveSummaryFromUnits(r.units);
  
    const lines = [];
    lines.push(`<div><strong>攪珠：</strong>${dRaw.drawNo}（${fmtYMD(dRaw.drawDate)}）</div>`);
    lines.push(`<div class="muted">正選：${dNumbers.join(" ")}　特別號：${String(dExtra).padStart(2,"0")}</div>`);
  
    const chances = toNum(t.chances, 0);
    const unitStake = toNum(t.unitStake, 10);
    const totalStake = toNum(t.totalStake, chances * unitStake);
  
    lines.push(`<div style="margin-top:8px;"><strong>你的彩票：</strong>${t.type || type}｜份數 ${chances.toLocaleString("en-US")}｜每份 HK$${unitStake}｜投注額 HK$ ${totalStake.toLocaleString("en-US")}</div>`);
  
    if(summary.length === 0){
      lines.push(`<div style="margin-top:10px;"><strong>結果：</strong>未中獎</div>`);
      if (hitText) lines.push(`<div class="muted" style="margin-top:6px;">${hitText}（未中獎）</div>`);
      return lines.join("");
    }
  
    const summaryText = summary.map(x=>`${x.name} × ${toNum(x.units,0).toLocaleString("en-US")}`).join("，");
    lines.push(`<div style="margin-top:10px;"><strong>中獎：</strong>${summaryText}</div>`);
  
    if(r.topPrizeNote){
      lines.push(`<div class="muted" style="margin-top:6px;">${r.topPrizeNote}</div>`);
    }
  
    return lines.join("");
  }

  function renderRecent(wins, titleLabel="近60日"){
    const title = `${titleLabel}（只顯示有中獎）`;
  
    const normalized = (wins || []).map(normalizeWinItem);
    const onlyWins = normalized.filter(w => (w.summary || []).length > 0);
  
    if(!onlyWins || onlyWins.length===0){
      return `<h4 style="margin:0 0 8px;">${title}</h4><div class="muted">未有中獎紀錄。</div>`;
    }
  
    const items = onlyWins.map(w=>{
      const s = (w.summary || []).map(x=>`${x.name}×${x.units}`).join("，");
      const fixed = w.fixedTotal ? `｜固定獎金 HK$ ${Number(w.fixedTotal).toLocaleString("en-US")}` : "";
      const note = w.topPrizeNote ? `｜${w.topPrizeNote}` : "";
  
      const hit = w.bestHit;
      const hitText = hit ? `命中：${hit.main}個正選${hit.extra ? " + 特別號" : ""}` : "";
  
      const nums = (w.numbers && w.numbers.length)
        ? `正選：${w.numbers.join(" ")}　特別號：${String(w.extra).padStart(2,"0")}`
        : "";
  
      return `
        <li style="margin:10px 0;">
          <div><strong>${w.drawNo}</strong>（${fmtYMD(w.drawDate)}）：${s}${fixed}${note}</div>
          ${hitText ? `<div class="muted">${hitText}</div>` : ""}
          ${nums ? `<div class="muted">${nums}</div>` : ""}
        </li>
      `;
    }).join("");
  
    return `<h4 style="margin:0 0 8px;">${title}</h4><ol>${items}</ol>`;
  }


  // -------------------------
  // Run check
  // -------------------------
  async function runCheck(){
    inputErrEl.textContent="";
    const ok = validateAndShow(true);
    if(!ok) return;

    statusEl.textContent="核對中…";

    resultCard.style.display = "block";
    if (halfResultEl) halfResultEl.checked = halfEl.checked;

    mainResultEl.innerHTML = `<div class="muted">核對中…</div>`;
    recentBlockEl.innerHTML = "";

    const payload = buildApiPayload();

    // DEBUG: 如果仍然冇中獎，先睇 server 究竟收到咩
    console.log("[check] payload", payload);

    try{
      const { res, data } = await fetchJsonNoStore("/api/check", {
        method: "POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify(payload),
      });

      if(!res.ok || !data.ok){
        statusEl.textContent="";
        const msg = data.error || ("HTTP " + res.status);
        inputErrEl.textContent = msg;
        mainResultEl.innerHTML = `<div class="error">核對失敗：${msg}</div>`;
        return;
      }

      console.log("[check] response keys", Object.keys(data || {}), data);

      statusEl.textContent="";
      resultCard.style.display="block";
      if (halfResultEl) halfResultEl.checked = halfEl.checked;

      // Prefer explicit flags if API provides
      const q = data.query || data.scope || {};
      const isMulti = !!data.multiInfo || !!q.multi;

      if (isMulti) {
        mainResultEl.innerHTML = `<div><strong>多期核對：</strong>由 ${data.multiInfo?.startDrawNo || q.startDrawNo} 起，共 ${data.multiInfo?.checked || "—"} 期（設定：${data.multiInfo?.count || q.multiCount || "—"} 期）</div>`;
        recentBlockEl.innerHTML = renderRecent((data.multiWins || []).map(normalizeWinItem), `多期核對（${data.multiInfo?.startDrawNo || q.startDrawNo} 起）`);
      } else if (!q.drawNo && !q.drawDate) {
        mainResultEl.innerHTML = data.rangeInfo?.label ? `<div class="muted">核對範圍：${data.rangeInfo.label}</div>` : "";
        const label = data.rangeInfo?.label || "近60日";
        recentBlockEl.innerHTML = renderRecent((data.recentWins || []).map(normalizeWinItem), label);
      } else {
        mainResultEl.innerHTML = renderMain(data.main);
        recentBlockEl.innerHTML = "";
      }

      // Optional: dev debug
      // console.log("check payload", payload);
      // console.log("check response", data);

    }catch(e){
      statusEl.textContent="";
      inputErrEl.textContent = "核對失敗：" + e.message;
      mainResultEl.innerHTML = `<div class="error">核對失敗：${e.message}</div>`;
    }
  }

  document.getElementById("check").addEventListener("click", runCheck);

  // init
  updateHint();
  updateChancesStake();
  updateHalfVisibility();
  updateRangeVisibility();
</script>

</body>
</html>
