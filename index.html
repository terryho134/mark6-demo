<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>六合彩 Mark Six｜示範站</title>
  <style>
    body { font-family: system-ui, -apple-system, "PingFang HK", "Noto Sans TC", Arial, sans-serif; margin: 24px; line-height: 1.6; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .ball { width: 42px; height: 42px; border-radius: 999px; border: 1px solid #999; display:flex; align-items:center; justify-content:center; font-weight: 700; }
    .muted { color: #666; font-size: 14px; }
    .error { color: #b00020; }
    .loading { opacity: 0.8; }
    code { background:#f5f5f5; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>六合彩 Mark Six｜示範站</h1>
  <p class="muted">此站以 <code>data/latest.json</code> 作資料來源（最快 MVP 版本）。</p>

  <div class="card">
    <h2>最新一期攪珠結果</h2>
    <div id="latest" class="loading">讀取中…</div>
  </div>

  <div class="card">
    <h2>下期攪珠</h2>
    <div id="next" class="loading">讀取中…</div>
  </div>

  <div class="card">
    <h2>最近攪珠（最新 20 期）</h2>
    <div id="history" class="loading">讀取中…</div>
    <div class="muted" style="margin-top:10px;">資料來源：<code>data/draws.json</code></div>
  </div>

  <div class="card">
    <h2>冷熱號統計（按最近 20 期計）</h2>
    <div id="stats" class="loading">讀取中…</div>
  </div>

    <div class="card">
    <h2>幸運號碼抽選</h2>

    <div class="row" style="margin: 10px 0;">
      <label class="muted">模式：</label>
      <select id="pickMode">
        <option value="random">隨機</option>
        <option value="hot">偏熱（按最近20期加權）</option>
        <option value="cold">偏冷（按最近20期加權）</option>
      </select>

      <button id="btnPick">抽 1 組</button>
      <button id="btnPick5">抽 5 組</button>
      <button id="btnPick10">抽 10 組</button>

      <button id="btnCopy">複製分享連結（1 組）</button>
      <button id="btnCopyList">複製全部號碼（多組）</button>
    </div>

    <div class="muted">單組結果（可用分享連結）：</div>
    <div id="pickResult" class="row" style="margin-top: 12px;"></div>

    <div class="muted" style="margin-top: 14px;">多組結果：</div>
    <div id="pickList" style="margin-top: 10px;"></div>

    <div id="pickHint" class="muted" style="margin-top: 10px;"></div>
  </div>



  <div class="card">
    <h2>聲明</h2>
    <div id="disclaimer" class="muted">—</div>
  </div>

  <script>
  function pad2(n){ return String(n).padStart(2, "0"); }

  let recentFreq = null; // Map<number, count>，由 draws.json 計出（最近20期）

  function renderLatest(data){
    const el = document.getElementById("latest");
    const d = data.draw || {};
    const nums = Array.isArray(d.numbers) ? d.numbers : [];
    const special = d.special;

    const numbersHtml = nums.map(n => `<div class="ball">${pad2(n)}</div>`).join("");
    const specialHtml = (typeof special === "number")
      ? `<div class="row" style="margin-top:10px;"><div class="muted">特別號：</div><div class="ball">${pad2(special)}</div></div>`
      : "";

    el.classList.remove("loading");
    el.innerHTML = `
      <div class="muted">期數：${d.drawNo || "—"}　｜　日期：${d.drawDate || "—"}</div>
      <div class="row" style="margin-top:10px;">${numbersHtml || "<span class='muted'>未有號碼</span>"}</div>
      ${specialHtml}
      <div class="muted" style="margin-top:10px;">更新時間：${data.updatedAt || "—"}</div>
    `;
  }

  function formatYMDToHK(ymd){
  // ymd: "YYYY-MM-DD"
  if(!ymd) return "";
  const m = ymd.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return ymd;
  return `${m[1]}年${m[2]}月${m[3]}日`;
}

  function renderNext(data){
    const nextEl = document.getElementById("next");
    nextEl.classList.remove("loading");
  
    const nd = data?.nextDraw || {};
    const drawNo = nd.drawNo || "";
    const drawDate = nd.drawDate || "";
    const jackpotM = (nd.jackpotMillion !== null && nd.jackpotMillion !== undefined) ? nd.jackpotMillion : "";
    const jackpotAmount = nd.jackpotAmount || null;
  
    if(!drawNo && !drawDate && jackpotM === ""){
      nextEl.innerHTML = `
        <div class="card">
          <h3>下期攪珠</h3>
          <p class="muted">暫未設定下期資料（請到管理頁輸入）。</p>
        </div>
      `;
      return;
    }
  
    nextEl.innerHTML = `
      <div class="card">
        <h3>下期攪珠</h3>
  
        <div style="margin-top:8px;">
          <div><strong>期數：</strong>${drawNo || "—"}</div>
          <div><strong>日期：</strong>${drawDate ? formatYMDToHK(drawDate) : "—"}</div>
          <div><strong>估計頭獎基金：</strong>
            ${
              jackpotM !== ""
                ? `約 HK$ ${Number(jackpotM).toLocaleString("en-US")} 百萬`
                : "—"
            }
            ${
              jackpotAmount
                ? `（約 HK$ ${Number(jackpotAmount).toLocaleString("en-US")}）`
                : ""
            }
          </div>
        </div>
  
        <p class="muted" style="margin-top:10px;">以官方公佈為準</p>
      </div>
    `;
  }


  function renderDisclaimer(data){
    const el = document.getElementById("disclaimer");
    el.textContent = data.disclaimer || "本頁資料僅供參考，以官方公佈為準。";
  }

  function renderHistory(drawsData){
    const el = document.getElementById("history");
    const draws = Array.isArray(drawsData.draws) ? drawsData.draws : [];
    el.classList.remove("loading");

    if(draws.length === 0){
      el.innerHTML = `<div class="muted">未有歷史資料</div>`;
      return;
    }

    const rows = draws.slice(0, 20).map(d => {
      const balls = (d.numbers || []).map(n => `<span class="ball" style="width:34px;height:34px;">${pad2(n)}</span>`).join("");
      const sp = (typeof d.special === "number")
        ? `<span class="muted" style="margin:0 6px;">特：</span><span class="ball" style="width:34px;height:34px;">${pad2(d.special)}</span>`
        : "";
      return `
        <div class="card" style="border-radius:10px; padding:12px; margin:10px 0;">
          <div class="muted">期數：${d.drawNo || "—"}　｜　日期：${d.drawDate || "—"}</div>
          <div class="row" style="margin-top:8px;">${balls}${sp}</div>
        </div>
      `;
    }).join("");

    el.innerHTML = rows;
  }

  function renderStats(drawsData){
    const el = document.getElementById("stats");
    const draws = Array.isArray(drawsData.draws) ? drawsData.draws : [];
    el.classList.remove("loading");

    const recent = draws.slice(0, 20);
    if(recent.length === 0){
      el.innerHTML = `<div class="muted">未有統計資料</div>`;
      return;
    }

    // 計次數（只計正選 6 個號碼；你想連特別號都計可以之後加）
    const freq = new Map();
    for(const d of recent){
      const nums = Array.isArray(d.numbers) ? d.numbers : [];
      for(const n of nums){
        freq.set(n, (freq.get(n) || 0) + 1);
      }
    }

    recentFreq = freq;

    // 生成排序
    const all = Array.from({length: 49}, (_, i) => i + 1).map(n => ({ n, c: freq.get(n) || 0 }));
    const hot = [...all].sort((a,b) => b.c - a.c || a.n - b.n).slice(0, 10);
    const cold = [...all].sort((a,b) => a.c - b.c || a.n - b.n).slice(0, 10);

    function listHtml(arr){
      return `
        <div class="row">
          ${arr.map(x => `
            <div style="text-align:center;">
              <div class="ball" title="出現次數：${x.c}">${pad2(x.n)}</div>
              <div class="muted">×${x.c}</div>
            </div>
          `).join("")}
        </div>
      `;
    }

    el.innerHTML = `
      <div class="muted">統計範圍：最近 ${recent.length} 期（只計 6 個正選號碼）</div>
      <h3 style="margin:12px 0 6px;">熱號 Top 10</h3>
      ${listHtml(hot)}
      <h3 style="margin:16px 0 6px;">冷號 Top 10</h3>
      ${listHtml(cold)}
    `;
  }

    function weightedPickOne(weightsMap, chosenSet){
  // weightsMap: Map<number, weight>
  // chosenSet: Set<number> (避免重覆)
  let total = 0;
  const items = [];
  for(let n=1; n<=49; n++){
    if(chosenSet.has(n)) continue;
    const w = weightsMap.get(n) || 1;
    total += w;
    items.push([n, w]);
  }
  let r = Math.random() * total;
  for(const [n,w] of items){
    r -= w;
    if(r <= 0) return n;
  }
  return items.length ? items[items.length-1][0] : 1;
}

function buildWeights(mode){
  // mode: random / hot / cold
  const w = new Map();
  for(let n=1; n<=49; n++){
    const c = (recentFreq && recentFreq.get(n)) ? recentFreq.get(n) : 0;

    if(mode === "hot"){
      // 出現越多，權重越高（+1 避免 0）
      w.set(n, c + 1);
    }else if(mode === "cold"){
      // 出現越少，權重越高
      // 以最近20期 0~? 次為例：用 (max - c + 1)
      // max 取 20（理論上最多20次，但實際會低很多）
      w.set(n, (20 - c) + 1);
    }else{
      // random
      w.set(n, 1);
    }
  }
  return w;
}

function pickSix(mode){
  const weights = buildWeights(mode);
  const chosen = new Set();
  while(chosen.size < 6){
    const n = weightedPickOne(weights, chosen);
    chosen.add(n);
  }
  return Array.from(chosen).sort((a,b)=>a-b);
}

function renderPick(nums){
  const el = document.getElementById("pickResult");
  el.innerHTML = nums.map(n => `<div class="ball">${pad2(n)}</div>`).join("");
}

    function pickMany(mode, count){
  const out = [];
  for(let i=0; i<count; i++){
    out.push(pickSix(mode));
  }
  return out;
}

function renderPickList(list){
  const el = document.getElementById("pickList");
  if(!el) return;

  if(!Array.isArray(list) || list.length === 0){
    el.innerHTML = `<div class="muted">—</div>`;
    return;
  }

  el.innerHTML = list.map((nums, idx) => {
    const balls = nums.map(n => `<span class="ball" style="width:34px;height:34px;">${pad2(n)}</span>`).join("");
    return `
      <div class="card" style="border-radius:10px; padding:12px; margin:10px 0;">
        <div class="muted">第 ${idx + 1} 組</div>
        <div class="row" style="margin-top:8px;">${balls}</div>
      </div>
    `;
  }).join("");
}

function formatPickListText(list){
  // 方便複製：01 07 12 23 36 44（每行一組）
  if(!Array.isArray(list) || list.length === 0) return "";
  return list
    .map(nums => nums.map(pad2).join(" "))
    .join("\n");
}

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    return false;
  }
}


function setPickHint(text){
  const el = document.getElementById("pickHint");
  el.textContent = text || "";
}

function updateUrlWithPick(nums){
  const pick = nums.map(pad2).join("-");
  const url = new URL(window.location.href);
  url.searchParams.set("pick", pick);
  window.history.replaceState({}, "", url.toString());
  return url.toString();
}

function readPickFromUrl(){
  const url = new URL(window.location.href);
  const pick = url.searchParams.get("pick");
  if(!pick) return null;
  const parts = pick.split("-").map(s => parseInt(s, 10)).filter(n => Number.isFinite(n));
  if(parts.length !== 6) return null;
  // 基本驗證：1-49、不可重覆
  const set = new Set(parts);
  if(set.size !== 6) return null;
  for(const n of set){
    if(n < 1 || n > 49) return null;
  }
  return Array.from(set).sort((a,b)=>a-b);
}

async function copyShareLink(){
  const link = window.location.href;
  try{
    await navigator.clipboard.writeText(link);
    setPickHint("已複製分享連結（可貼去 WhatsApp/Telegram）。");
  }catch(e){
    setPickHint("複製失敗：你可以手動複製瀏覽器網址列。");
  }
}


  async function fetchJsonWithFallback(primaryUrl, fallbackUrl){
  // primaryUrl / fallbackUrl 都會加 cache-bust
    async function tryFetch(url){
      const res = await fetch(url + (url.includes("?") ? "&" : "?") + "v=" + Date.now(), { cache: "no-store" });
      if(!res.ok) throw new Error(url + " HTTP " + res.status);
      return await res.json();
    }
  
    try{
      return await tryFetch(primaryUrl);
    }catch(primaryErr){
      if(!fallbackUrl) throw primaryErr;
      return await tryFetch(fallbackUrl);
    }
  }
  
  async function load(){
    const latestEl = document.getElementById("latest");
    const nextEl = document.getElementById("next");
    const historyEl = document.getElementById("history");
    const statsEl = document.getElementById("stats");
  
    try{
      // 先用 API，失敗就 fallback 去 data/latest.json
      const latestData = await fetchJsonWithFallback("/api/latest", "/data/latest.json");
      renderLatest(latestData);
      renderNext(latestData);
      renderDisclaimer(latestData);
    }catch(err){
      latestEl.classList.remove("loading");
      nextEl.classList.remove("loading");
      latestEl.innerHTML = `<div class="error">讀取最新一期失敗：${err.message}</div>`;
      nextEl.innerHTML = `<div class="error">請稍後再試。</div>`;
    }
  
    try{
      // 先用 API recent，失敗就 fallback 去 data/draws.json
      const recentData = await fetchJsonWithFallback("/api/recent?limit=20", "/data/draws.json");
  
      // recentData.draws 結構同 draws.json 幾乎一樣：{ draws: [...] }
      renderHistory(recentData);
      renderStats(recentData);
  
      // 告訴抽號碼模組：頻率可用了（如果你有偏冷/偏熱）
      // （renderStats 裡面你已經做了 recentFreq = freq，所以這裡不用再做）
    }catch(err){
      historyEl.classList.remove("loading");
      statsEl.classList.remove("loading");
      historyEl.innerHTML = `<div class="error">讀取歷史資料失敗：${err.message}</div>`;
      statsEl.innerHTML = `<div class="error">請稍後再試。</div>`;
    }
  }
  
  load();


  // 綁定抽號碼按鈕
  const btnPick = document.getElementById("btnPick");
  const btnCopy = document.getElementById("btnCopy");
  const modeSel = document.getElementById("pickMode");

  const btnPick5 = document.getElementById("btnPick5");
  const btnPick10 = document.getElementById("btnPick10");
  const btnCopyList = document.getElementById("btnCopyList");
  
  let lastPickList = []; // 記住最近一次多組結果，方便複製
  
  btnPick5?.addEventListener("click", () => {
    const mode = modeSel?.value || "random";
    lastPickList = pickMany(mode, 5);
    renderPickList(lastPickList);
    setPickHint("已產生 5 組號碼，可按「複製全部號碼（多組）」貼去訊息。");
  });
  
  btnPick10?.addEventListener("click", () => {
    const mode = modeSel?.value || "random";
    lastPickList = pickMany(mode, 10);
    renderPickList(lastPickList);
    setPickHint("已產生 10 組號碼，可按「複製全部號碼（多組）」貼去訊息。");
  });
  
  btnCopyList?.addEventListener("click", async () => {
    const text = formatPickListText(lastPickList);
    if(!text){
      setPickHint("未有多組結果：請先按「抽 5 組」或「抽 10 組」。");
      return;
    }
    const ok = await copyText(text);
    setPickHint(ok ? "已複製全部號碼（每行一組）。" : "複製失敗：你可以手動選取多組結果再複製。");
  });

  
  // 先嘗試從網址讀取 pick
  const existing = readPickFromUrl();
  if(existing){
    renderPick(existing);
    setPickHint("已從分享連結載入此組號碼。");
  }
  
  // 點擊抽選
  btnPick?.addEventListener("click", () => {
    const mode = modeSel?.value || "random";
    const nums = pickSix(mode);
    renderPick(nums);
    const link = updateUrlWithPick(nums);
    setPickHint(`已更新網址，可直接分享：${link}`);
  });
  
  // 複製分享連結
  btnCopy?.addEventListener("click", () => {
    copyShareLink();
  });

  load();
</script>

</body>
</html>
