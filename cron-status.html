<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cron Status｜Mark6</title>
  <style>
    body { font-family: system-ui, -apple-system, "PingFang HK", "Noto Sans TC", Arial, sans-serif; margin:24px; line-height:1.55; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; }
    .muted { color:#666; font-size:14px; }
    .bad { color:#b00020; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
    button,input,select { padding:8px 10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .pill { display:inline-block; padding:2px 10px; border-radius:999px; background:#f3f3f3; font-size:13px; }
    .pill.ok { background:#e7f6e7; color:#0a7a0a; border:1px solid #bfe7bf; }
    .pill.fail { background:#ffe7ea; color:#b00020; border:1px solid #ffc0c8; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-top:1px solid #eee; padding:8px 6px; text-align:left; vertical-align: top; }
    th { background:#fafafa; }
  </style>
</head>
<body>
  <h1>Cron Status</h1>
  <p class="muted">查看：自動抓取（cron）最後一次執行時間、狀態、DB 最新一期，以及資料健康檢查。</p>

  <div class="card">
    <div class="row">
      <button id="refresh">刷新</button>

      <label class="muted">
        自動刷新（30秒）
        <input id="auto" type="checkbox">
      </label>

      <span class="pill" id="pill">未載入</span>
      <span class="muted" id="hint"></span>

      <span style="margin-left:auto;"></span>

      <label class="muted">
        Health 檢查期數：
        <select id="limit">
          <option value="30">30</option>
          <option value="60" selected>60</option>
          <option value="100">100</option>
          <option value="150">150</option>
          <option value="200">200</option>
        </select>
      </label>

      <span class="muted">（如有 token：<code class="mono">?token=xxx</code>）</span>
    </div>
  </div>

  <div class="card" id="statusCard">
    <h3 style="margin-top:0;">狀態</h3>
    <div id="status"></div>
  </div>

  <div class="card" id="latestCard">
    <h3 style="margin-top:0;">最新一期</h3>
    <div id="latest"></div>
  </div>

  <div class="card" id="healthCard">
    <div class="row" style="justify-content:space-between;">
      <h3 style="margin:0;">資料健康檢查（Health）</h3>
      <span id="healthPill" class="pill">—</span>
    </div>
    <div class="muted" style="margin-top:6px;" id="healthSummary"></div>
    <div id="healthBody" style="margin-top:10px;"></div>
  </div>

  <p><a href="/">返回首頁</a></p>

<script>
  const pill = document.getElementById("pill");
  const hint = document.getElementById("hint");
  const statusEl = document.getElementById("status");
  const latestEl = document.getElementById("latest");
  const autoEl = document.getElementById("auto");
  const limitEl = document.getElementById("limit");

  const healthPill = document.getElementById("healthPill");
  const healthSummary = document.getElementById("healthSummary");
  const healthBody = document.getElementById("healthBody");

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }
  function fmtNums(nums){
    if(!Array.isArray(nums)) return "";
    return nums.map(n => String(Number(n))).join(" ");
  }

  function renderHealth(h){
    if(!h){
      healthPill.className = "pill";
      healthPill.textContent = "—";
      healthSummary.textContent = "";
      healthBody.innerHTML = `<div class="muted">未有 health 資料。</div>`;
      return;
    }

    const ok = !!h.ok;
    healthPill.className = "pill " + (ok ? "ok" : "fail");
    healthPill.textContent = ok ? "OK" : "有問題";

    const dupCount = (h.duplicateDrawNo || []).length;
    healthSummary.innerHTML = `
      已檢查 <strong>${esc(h.checked)}</strong> 期（limit=${esc(h.limit)}），
      issues：<strong>${esc(h.issuesCount)}</strong>，
      重覆 drawNo：<strong>${esc(dupCount)}</strong>
    `;

    const parts = [];

    if (dupCount > 0) {
      const rows = h.duplicateDrawNo
        .slice(0, 20)
        .map(x => `<li><code class="mono">${esc(x.drawNo)}</code> × ${esc(x.cnt)}</li>`)
        .join("");
      parts.push(`
        <div style="margin:10px 0;">
          <div class="bad"><strong>紅旗：drawNo 重覆（最多顯示20）</strong></div>
          <ol>${rows}</ol>
        </div>
      `);
    }

    if (!h.issues || h.issues.length === 0) {
      parts.push(`<div class="muted">未發現問題（以目前檢查範圍計）。</div>`);
    } else {
      const rows = h.issues.map(it => `
        <tr>
          <td><code class="mono">${esc(it.drawNo)}</code><div class="muted">${esc(it.drawDate)}</div></td>
          <td class="mono">${esc(it.type)}</td>
          <td>${esc(it.detail)}</td>
        </tr>
      `).join("");

      parts.push(`
        <table>
          <thead>
            <tr>
              <th style="width:170px;">期數 / 日期</th>
              <th style="width:150px;">類型</th>
              <th>說明</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        <div class="muted" style="margin-top:8px;">
          只顯示最多 200 條 issues。需要更深入就加大 limit 或另做專用 health 頁。
        </div>
      `);
    }

    if (Array.isArray(h.notes) && h.notes.length) {
      parts.push(`
        <div class="muted" style="margin-top:10px;">
          <strong>說明：</strong>
          <ul>${h.notes.map(x => `<li>${esc(x)}</li>`).join("")}</ul>
        </div>
      `);
    }

    healthBody.innerHTML = parts.join("");
  }

  async function load(){
    pill.textContent = "載入中…";
    pill.className = "pill";
    hint.textContent = "";
    statusEl.innerHTML = "";
    latestEl.innerHTML = "";
    renderHealth(null);

    const u = new URL(location.href);
    const token = u.searchParams.get("token");
    const lim = limitEl.value || "60";

    const api = token
      ? `/api/cron-status?token=${encodeURIComponent(token)}&limit=${encodeURIComponent(lim)}`
      : `/api/cron-status?limit=${encodeURIComponent(lim)}`;

    try{
      const res = await fetch(api, { headers: { "accept":"application/json" } });
      const text = await res.text();

      let data;
      try { data = JSON.parse(text); }
      catch {
        pill.textContent = "失敗";
        pill.className = "pill fail";
        hint.textContent = `API 回傳非 JSON（HTTP ${res.status}）`;
        statusEl.innerHTML = `<div class="bad">前 200 字：<code class="mono">${esc(text.slice(0,200))}</code></div>`;
        return;
      }

      if(!res.ok || !data.ok){
        pill.textContent = "失敗";
        pill.className = "pill fail";
        hint.textContent = `HTTP ${res.status}`;
        statusEl.innerHTML = `<div class="bad">${esc(data.error || "Unknown error")}</div>`;
        return;
      }

      pill.textContent = "OK";
      pill.className = "pill ok";
      hint.textContent = `Server(HK)：${data.serverTimeHK || "-"}`;

      const m = data.meta || {};
      const at = m.last_auto_fetch_at?.hk || m.last_auto_fetch_at?.value || null;
      const st = m.last_auto_fetch_status?.value || null;

      statusEl.innerHTML = `
        <div><strong>最後自動抓取時間：</strong>${at ? esc(at) : "—"}</div>
        <div><strong>狀態：</strong>${st ? esc(st) : "—"}</div>
        <div class="muted" style="margin-top:6px;">DB 目前總期數：${esc(data.totalDraws ?? "—")}</div>
      `;

      const L = data.latest;
      if(!L){
        latestEl.innerHTML = `<div class="muted">未找到 draws 資料。</div>`;
      }else{
        latestEl.innerHTML = `
          <div><strong>期數：</strong>${esc(L.drawNo)}</div>
          <div><strong>日期：</strong>${esc(L.drawDate)}</div>
          <div class="muted" style="margin-top:6px;">
            正選：${esc(fmtNums(L.numbers))}　特別號：${esc(L.special)}
          </div>
        `;
      }

      renderHealth(data.health);

    }catch(e){
      pill.textContent = "失敗";
      pill.className = "pill fail";
      hint.textContent = "Network / fetch error";
      statusEl.innerHTML = `<div class="bad">${esc(e.message || e)}</div>`;
    }
  }

  document.getElementById("refresh").addEventListener("click", load);

  limitEl.addEventListener("change", ()=>{
    load();
  });

  let timer = null;
  autoEl.addEventListener("change", ()=>{
    if(autoEl.checked){
      load();
      timer = setInterval(load, 30000);
    }else{
      if(timer) clearInterval(timer);
      timer = null;
    }
  });

  load();
</script>
</body>
</html>
