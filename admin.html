<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mark6 管理頁</title>
  <style>
    body { font-family: system-ui, -apple-system, "PingFang HK", "Noto Sans TC", Arial, sans-serif; margin: 24px; line-height: 1.6; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input, button { padding: 8px 10px; }
    .muted { color:#666; font-size: 14px; }
    .error { color:#b00020; }
    .ok { color:#0a7a0a; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
    input[readonly] { background:#fafafa; }
  </style>
</head>
<body>
  <h1>Mark6 管理頁（寫入 D1）</h1>
  <p class="muted">提示：密碼你而家設為 <code>123456</code>（非常易被猜中，建議之後改長啲）。</p>

  <div class="card">
    <div class="row">
      <label>管理密碼</label>
      <input id="key" type="password" placeholder="123456" />
      <button id="saveKey">記住密碼</button>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid #eee;">

    <h3 style="margin:0 0 8px;">輸入今期攪珠結果</h3>

    <div class="row">
      <label>期數</label>
      <input id="drawNo" placeholder="例如：25/018" />
      <span class="muted" id="prefillHint"></span>
    </div>

    <div class="row" style="margin-top:10px;">
      <label>攪珠日期</label>
      <input id="drawDate" type="date" />
    </div>

    <div class="row" style="margin-top:10px;">
      <label>6 個號碼</label>
      <input id="nums" placeholder="例如：1 7 12 23 36 44" style="min-width: 320px;" />
      <label>特別號</label>
      <input id="special" type="number" min="1" max="49" style="width:90px;" />
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid #eee;">

    <h3 style="margin:0 0 8px;">同時更新下期資料</h3>

    <div class="row">
      <label>下期攪珠日期</label>
      <input id="nextDrawDate" type="date" />
    </div>

    <div class="row" style="margin-top:10px;">
      <label>下期期數（自動）</label>
      <input id="nextDrawNo" readonly placeholder="會自動計算" />
      <span class="muted">同一年：+1；新一年：<code>001/新年份</code></span>
    </div>

    <div class="row" style="margin-top:10px;">
      <label>估計頭獎基金（百萬位）</label>
      <input id="nextJackpotM" type="number" min="0" step="1" style="width:120px;" placeholder="例如 22" />
      <span class="muted" id="jackpotHint"></span>
    </div>

    <div class="row" style="margin-top:14px;">
      <button id="submit">提交更新</button>
    </div>

    <div id="msg" class="muted" style="margin-top:12px;"></div>
  </div>

  <p><a href="/">返回首頁</a></p>

  <script>
    const keyEl = document.getElementById("key");
    const msgEl = document.getElementById("msg");

    const drawNoEl = document.getElementById("drawNo");
    const drawDateEl = document.getElementById("drawDate");
    const nextDrawDateEl = document.getElementById("nextDrawDate");
    const nextDrawNoEl = document.getElementById("nextDrawNo");
    const nextJackpotMEl = document.getElementById("nextJackpotM");

    const prefillHintEl = document.getElementById("prefillHint");
    const jackpotHintEl = document.getElementById("jackpotHint");

    // load saved key
    const saved = localStorage.getItem("ADMIN_KEY");
    if(saved) keyEl.value = saved;

    document.getElementById("saveKey").addEventListener("click", () => {
      localStorage.setItem("ADMIN_KEY", keyEl.value || "");
      msgEl.innerHTML = `<span class="ok">已記住密碼（只儲存在你部電腦瀏覽器）。</span>`;
    });

    function parseNums(s){
      return (s || "").trim().split(/[\s,，]+/).filter(Boolean).map(x => parseInt(x,10));
    }

    function parseDrawNo(s){
      s = String(s || "").trim();
    
      // 新格式：YY/XXX 例：25/018
      let m = s.match(/^(\d{2})\s*\/\s*(\d{3})$/);
      if(m){
        const yy = parseInt(m[1],10);
        const seq = parseInt(m[2],10);
        const yearFull = 2000 + yy; // 假設 2000-2099
        return { yy, yearFull, seq };
      }
    
      // 兼容舊格式（如你 DB 以前有）：XXX/YYYY 例：018/2025
      m = s.match(/^(\d{1,3})\s*\/\s*(\d{4})$/);
      if(m){
        const seq = parseInt(m[1],10);
        const yearFull = parseInt(m[2],10);
        const yy = yearFull % 100;
        return { yy, yearFull, seq };
      }
    
      return null;
    }
    
    function formatDrawNo(yearFull, seq){
      const yy = String(yearFull % 100).padStart(2, "0");
      const s = String(seq).padStart(3, "0");
      return `${yy}/${s}`;
    }
    
    // 計算下期期數：根據「今期 seq」+「下期日期 year」推算
    function computeNextDrawNo(){
      const cur = parseDrawNo(drawNoEl.value);
    
      const nd = nextDrawDateEl.value; // YYYY-MM-DD
      if(!nd || !cur) { nextDrawNoEl.value = ""; return; }
    
      const nextYearFull = parseInt(nd.slice(0,4),10);
      if(!Number.isFinite(nextYearFull)) { nextDrawNoEl.value = ""; return; }
    
      if(nextYearFull === cur.yearFull){
        nextDrawNoEl.value = formatDrawNo(nextYearFull, cur.seq + 1);
      }else{
        nextDrawNoEl.value = formatDrawNo(nextYearFull, 1); // 新一年 -> YY/001
      }
    }


    // 預填：由 DB 取最新一期，再推算「你下一期要輸入」的 drawNo
    let lastDraw = null;
    let drawNoTouched = false;

    drawNoEl.addEventListener("input", () => {
      drawNoTouched = true;
      computeNextDrawNo();
    });

    drawDateEl.addEventListener("change", () => {
      if(!lastDraw || drawNoTouched) return;
    
      const y = drawDateEl.value ? parseInt(drawDateEl.value.slice(0,4),10) : null;
      const last = parseDrawNo(lastDraw.drawNo);
      const lastYearByDate = lastDraw.drawDate ? parseInt(lastDraw.drawDate.slice(0,4),10) : null;
      const lastYearFull = Number.isFinite(lastYearByDate) ? lastYearByDate : (last ? last.yearFull : null);
    
      if(!y || !last || !lastYearFull) return;
    
      if(y === lastYearFull){
        drawNoEl.value = formatDrawNo(y, last.seq + 1);
      }else{
        drawNoEl.value = formatDrawNo(y, 1);
      }
    
      prefillHintEl.textContent = `(已根據 DB 最新一期自動預填)`;
      computeNextDrawNo();
    });


    nextDrawDateEl.addEventListener("change", computeNextDrawNo);

    nextJackpotMEl.addEventListener("input", () => {
      const m = parseInt(nextJackpotMEl.value, 10);
      if(Number.isFinite(m)){
        jackpotHintEl.textContent = `= 約 HK$ ${(m*1000000).toLocaleString("en-US")}`;
      }else{
        jackpotHintEl.textContent = "";
      }
    });

    async function prefillFromDB(){
      try{
        const res = await fetch("/api/latest?v=" + Date.now(), { cache: "no-store" });
        if(!res.ok) return;
        const data = await res.json();
        if(!data?.draw?.drawNo) return;

        lastDraw = data.draw;

        // 只在 drawNo 空白時預填（避免覆蓋你手動輸入）
        if(!drawNoEl.value){
          // 用 DB 最新一期（lastDraw）去推算「你下一期要輸入」的期數
          const last = parseDrawNo(lastDraw.drawNo);
          const lastYearByDate = lastDraw.drawDate ? parseInt(lastDraw.drawDate.slice(0,4),10) : null;
        
          // 以 drawDate 的年份為主（最穩）
          const lastYearFull = Number.isFinite(lastYearByDate) ? lastYearByDate : (last ? last.yearFull : null);
          const todayYearFull = new Date().getFullYear();
        
          if(last && lastYearFull === todayYearFull){
            drawNoEl.value = formatDrawNo(todayYearFull, last.seq + 1);
          }else{
            // 跨年（或解析不到 last），就先預填為今年第 1 期（你亦可之後改攪珠日期再自動修正）
            drawNoEl.value = formatDrawNo(todayYearFull, 1);
          }
        
          prefillHintEl.textContent = `(已根據 DB 最新一期自動預填；如跨年，改「攪珠日期」會自動修正)`;
          computeNextDrawNo();
        }


        // 順便預填已存的下期資料（可選）
        if(data?.nextDraw?.drawDate && !nextDrawDateEl.value) nextDrawDateEl.value = data.nextDraw.drawDate;
        if(data?.nextDraw?.jackpotMillion !== null && data?.nextDraw?.jackpotMillion !== undefined && !nextJackpotMEl.value){
          nextJackpotMEl.value = data.nextDraw.jackpotMillion;
          nextJackpotMEl.dispatchEvent(new Event("input"));
        }
        computeNextDrawNo();
      }catch(e){
        // ignore
      }
    }

    document.getElementById("submit").addEventListener("click", async () => {
      msgEl.textContent = "提交中…";

      const payload = {
        drawNo: drawNoEl.value.trim(),
        drawDate: drawDateEl.value,
        numbers: parseNums(document.getElementById("nums").value),
        special: parseInt(document.getElementById("special").value, 10),

        // 下期資料
        nextDrawDate: nextDrawDateEl.value || null,
        nextDrawNo: nextDrawNoEl.value || null,
        nextJackpotM: nextJackpotMEl.value ? parseInt(nextJackpotMEl.value, 10) : null
      };

      try{
        const res = await fetch("/api/admin/upsert", {
          method: "POST",
          headers: {
            "content-type": "application/json",
            "X-Admin-Key": keyEl.value || ""
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=> ({}));
        if(!res.ok){
          msgEl.innerHTML = `<span class="error">失敗：${data.error || ("HTTP " + res.status)}</span>`;
          return;
        }
        msgEl.innerHTML = `<span class="ok">成功！刷新首頁即可見到更新。</span>`;
      }catch(e){
        msgEl.innerHTML = `<span class="error">提交失敗：${e.message}</span>`;
      }
    });

    prefillFromDB();
  </script>
</body>
</html>
